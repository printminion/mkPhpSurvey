<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>mkSurvey: class.Logger.php Quellcode</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Erzeugt von Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Hauptseite</span></a></li>
    <li><a href="namespaces.html"><span>Pakete</span></a></li>
    <li><a href="annotated.html"><span>Klassen</span></a></li>
    <li class="current"><a href="files.html"><span>Dateien</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>uchen&nbsp;nach&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<h1>class.Logger.php</h1><a href="class_8Logger_8php.html">gehe zur Dokumentation dieser Datei</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?
<a name="l00009"></a>00009 include_once(<a class="code" href="configuration_8php.html#285bf1ce0b8d02fcd7a9f6e2baa8eb77">LANGUAGE_PATH</a>.'/lang_usermenu.php');
<a name="l00010"></a><a class="code" href="class_8Logger_8php.html#a8840e348fe4a986d494b9ae74e3c764">00010</a> define('<a class="code" href="class_8Logger_8php.html#a8840e348fe4a986d494b9ae74e3c764">USERTYPEID_NONE</a>',0);
<a name="l00011"></a><a class="code" href="class_8Logger_8php.html#16d9584428f304eeb1feea27966041bf">00011</a> define('<a class="code" href="class_8Logger_8php.html#16d9584428f304eeb1feea27966041bf">USERTYPEID_USER</a>',1);
<a name="l00012"></a><a class="code" href="class_8Logger_8php.html#ecd1d4f709982a5a46e5c243d688c31a">00012</a> define('<a class="code" href="class_8Logger_8php.html#ecd1d4f709982a5a46e5c243d688c31a">USERTYPEID_ADMIN</a>',2);
<a name="l00013"></a><a class="code" href="class_8Logger_8php.html#e6667279ef090ed366333f135e773496">00013</a> define('<a class="code" href="class_8Logger_8php.html#e6667279ef090ed366333f135e773496">USERTYPEID_SUPERADMIN</a>',3);
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="classLogger.html">00015</a> <span class="keyword">class </span><a class="code" href="classLogger.html">Logger</a> {
<a name="l00021"></a><a class="code" href="classLogger.html#4c5e34f5dd82480f8131444a8e925b6d">00021</a>    var <a class="code" href="classLogger.html#4c5e34f5dd82480f8131444a8e925b6d">$bLogged</a>;
<a name="l00022"></a><a class="code" href="classLogger.html#5d6758111378e2c0ed87169dd2ff538d">00022</a>    var <a class="code" href="classLogger.html#5d6758111378e2c0ed87169dd2ff538d">$lUserId</a> = 0;
<a name="l00023"></a>00023    <span class="comment">//         var $strUserType;</span>
<a name="l00024"></a>00024 
<a name="l00030"></a><a class="code" href="classLogger.html#fa46383f383164d19c08d48b8b089803">00030</a>    var <a class="code" href="classLogger.html#fa46383f383164d19c08d48b8b089803">$bAdmin</a>;
<a name="l00031"></a><a class="code" href="classLogger.html#985c21e871bc5e952635b19efd0406ac">00031</a>    var <a class="code" href="classLogger.html#985c21e871bc5e952635b19efd0406ac">$lUserType</a> = 0;
<a name="l00032"></a><a class="code" href="classLogger.html#5218f0f63b5ef80983bda1ff1ac59fb7">00032</a>    var <a class="code" href="classLogger.html#5218f0f63b5ef80983bda1ff1ac59fb7">$strUserNick</a>;
<a name="l00033"></a>00033 
<a name="l00039"></a><a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">00039</a>    var <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>;
<a name="l00045"></a><a class="code" href="classLogger.html#647b3dea9efb906a0a6f72f3cf43d696">00045</a>    var <a class="code" href="classLogger.html#647b3dea9efb906a0a6f72f3cf43d696">$_bJustLogged</a> = <span class="keyword">false</span>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">//   var $_UserTypeString;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 
<a name="l00055"></a><a class="code" href="classLogger.html#14770561f478cc9228b1ee70d539e014">00055</a>    function <a class="code" href="classLogger.html#14770561f478cc9228b1ee70d539e014">Logger</a>() {
<a name="l00056"></a>00056       global <a class="code" href="configuration_8db_8php.html#1fa3127fc82f96b1436d871ef02be319">$db</a>, <a class="code" href="configuration_8db_8php.html#711797613cb863ca0756df789c396bf2">$host</a>, <a class="code" href="configuration_8db_8php.html#598ca4e71b15a1313ec95f0df1027ca5">$user</a>, <a class="code" href="configuration_8db_8php.html#607686ef9f99ea7c42f4f3dd3dbb2b0d">$password</a>,$dbprefix,$_COOKIE,<a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>,$absolute_path,$usercookie,<a class="code" href="SessionCookie_8php.html#93d36a95c848bb1af38554eb7ecd6174">$_SESSION</a>;
<a name="l00057"></a>00057 
<a name="l00058"></a>00058       <span class="comment">//      print_r($_SESSION);</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060       <span class="keywordflow">if</span> ($_SESSION[<span class="stringliteral">"oLogger"</span>]!=<span class="stringliteral">""</span>){
<a name="l00061"></a>00061          $oLogger = $_SESSION[<span class="stringliteral">"oLogger"</span>];
<a name="l00062"></a>00062       }<span class="keywordflow">else</span>{
<a name="l00063"></a>00063          $_SESSION[<span class="stringliteral">"oLogger"</span>] = $oLogger;
<a name="l00064"></a>00064       }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066       $this-&gt;bLogged = 0;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068       <span class="comment">//      include_once ("configuration.php");</span>
<a name="l00069"></a>00069       <span class="comment">//      $link=mysql_connect($host, $user, $password);</span>
<a name="l00070"></a>00070       <span class="comment">//      mysql_select_db($db) or die("Query failed with error: ".$query.mysql_error());</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072       <span class="comment">//      $list=mysql_connect($host, $user, $password);</span>
<a name="l00073"></a>00073       <span class="comment">//      mysql_select_db($db) or die("Query failed with error: ".mysql_error());</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075       <span class="comment">//      $gidType = $this-&gt;checkaccess($_COOKIE["usercookie"], $db, $dbprefix);</span>
<a name="l00076"></a>00076       <span class="comment">//      $gid     = $this-&gt;checkaccess_uid($_COOKIE["usercookie"], $db, $dbprefix);</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078       $gidType = $this-&gt;<a class="code" href="classLogger.html#531acb23b4cd12bb71f33e2327def989">checkaccess</a>($_SESSION[<span class="stringliteral">"usercookie"</span>], $db, $dbprefix);
<a name="l00079"></a>00079       $gid     = $this-&gt;<a class="code" href="classLogger.html#3d4c0e693f4e76414e723a5eebd802f8">checkaccess_uid</a>($_SESSION[<span class="stringliteral">"usercookie"</span>], $db, $dbprefix);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 
<a name="l00082"></a>00082       <span class="comment">//      echo "usercookie:".$_SESSION["usercookie"]."&lt;br&gt;";</span>
<a name="l00083"></a>00083       <span class="comment">//      $gidType = $this-&gt;checkaccess($_SESSION["usercookie"], $db, $dbprefix);</span>
<a name="l00084"></a>00084       <span class="comment">//      $gid     = $this-&gt;checkaccess_uid($_SESSION["usercookie"], $db, $dbprefix);</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a>00087       <span class="comment">//</span>
<a name="l00088"></a>00088       <span class="comment">//         echo "&lt;pre&gt;";</span>
<a name="l00089"></a>00089       <span class="comment">//         print_r($_COOKIE);</span>
<a name="l00090"></a>00090       <span class="comment">//      echo "gid:".$gid."&lt;br&gt;";</span>
<a name="l00091"></a>00091       <span class="comment">//      echo "i_uid:".$i_uid."&lt;br&gt;";</span>
<a name="l00092"></a>00092       <span class="comment">//      debug_sql("$gid : $gidType ");</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094       <span class="keywordflow">if</span> ($database == null){
<a name="l00095"></a>00095          <span class="keywordflow">if</span>(!class_exists(<span class="stringliteral">"database"</span>)){
<a name="l00096"></a>00096             include_once(<a class="code" href="configuration_8php.html#4617283702a69a0d5ee6d9797672e391">CLASSES_PATH</a>.<span class="stringliteral">"/database.php"</span>);
<a name="l00097"></a>00097          }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099          $database = <span class="keyword">new</span> <a class="code" href="classdatabase.html">database</a>();
<a name="l00100"></a>00100          $this-&gt;<a class="code" href="classdatabase.html">database</a> =&amp; $database;
<a name="l00101"></a>00101       }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103       <span class="keywordflow">if</span> ($gid != 0){
<a name="l00104"></a>00104          $this-&gt;bLogged = <span class="keyword">true</span>;
<a name="l00105"></a>00105          $this-&gt;lUserId = $gid;
<a name="l00106"></a>00106          $this-&gt;lUserType = $gidType;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">         ###################</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="preprocessor">         # get User Info</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>         <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT u.*</span>
<a name="l00111"></a>00111 <span class="stringliteral">                   FROM "</span>.$dbprefix.<span class="stringliteral">"users u</span>
<a name="l00112"></a>00112 <span class="stringliteral">                  WHERE u.id='$gid'"</span>;
<a name="l00113"></a>00113          <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=$database-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00114"></a>00114          <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)!=0){
<a name="l00115"></a>00115             $resUser = mysql_fetch_array(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00116"></a>00116             <span class="comment">//            print_r($resUser);</span>
<a name="l00117"></a>00117             $this-&gt;strUserNick = $resUser['username'];
<a name="l00118"></a>00118          }
<a name="l00119"></a>00119          <span class="keywordflow">if</span> ($this-&gt;lUserType == 2) {
<a name="l00120"></a>00120             $this-&gt;bAdmin = <span class="keyword">true</span>;
<a name="l00121"></a>00121          }
<a name="l00122"></a>00122 <span class="preprocessor">         #</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">         ##################</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>      }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126       <span class="comment">//      print_r($_SESSION["oLogger"]);</span>
<a name="l00127"></a>00127       $_SESSION[<span class="stringliteral">"oLogger"</span>] = $oLogger;
<a name="l00128"></a>00128       <span class="comment">//      print_r($_SESSION["oLogger"]);</span>
<a name="l00129"></a>00129    }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 
<a name="l00140"></a><a class="code" href="classLogger.html#e42f0ef5814aa36c4bb1b902d342aef8">00140</a>    function <a class="code" href="classLogger.html#e42f0ef5814aa36c4bb1b902d342aef8">doLogin</a>($userNick, $userPasswort, $urlLoginSuccess = null, $urlLoginFailed = null){
<a name="l00141"></a>00141       global <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>, $dbprefix, $_COOKIE, <a class="code" href="SessionCookie_8php.html#93d36a95c848bb1af38554eb7ecd6174">$_SESSION</a>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">//      debug_sql("doLogin($userNick, $userPasswort, $urlLoginSuccess, $urlLoginFailed)");</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145       $username = $userNick;
<a name="l00146"></a>00146       $passwd   = $userPasswort;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148       <span class="keywordflow">if</span> ($database == null){
<a name="l00149"></a>00149          <span class="keywordflow">if</span>(!class_exists(<span class="stringliteral">"database"</span>)){
<a name="l00150"></a>00150             include_once(<a class="code" href="configuration_8php.html#4617283702a69a0d5ee6d9797672e391">CLASSES_PATH</a>.<span class="stringliteral">"/database.php"</span>);
<a name="l00151"></a>00151          }
<a name="l00152"></a>00152          $database = <span class="keyword">new</span> <a class="code" href="classdatabase.html">database</a>();
<a name="l00153"></a>00153          $this-&gt;<a class="code" href="classdatabase.html">database</a> =&amp; $database;
<a name="l00154"></a>00154       }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156       <span class="keywordflow">if</span> ((trim($username)==<span class="stringliteral">""</span>) || (trim($passwd)==<span class="stringliteral">""</span>)){
<a name="l00157"></a>00157          <span class="comment">//echo "&lt;SCRIPT&gt; alert(\""._LOGIN_INCOMPLETE."\"); window.history.go(-1); &lt;/SCRIPT&gt;\n";</span>
<a name="l00158"></a>00158          $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlLoginFailed.<span class="stringliteral">"&amp;msg="</span>._LOGIN_INCOMPLETE);
<a name="l00159"></a>00159       }<span class="keywordflow">else</span>{
<a name="l00160"></a>00160          $passwd   = md5($passwd);
<a name="l00161"></a>00161          <span class="comment">//         debug_sql($passwd,'$passwd');</span>
<a name="l00162"></a>00162          $sqlQuery = <span class="stringliteral">"SELECT id,</span>
<a name="l00163"></a>00163 <span class="stringliteral">                             gid,</span>
<a name="l00164"></a>00164 <span class="stringliteral">                             block,</span>
<a name="l00165"></a>00165 <span class="stringliteral">                             usertype</span>
<a name="l00166"></a>00166 <span class="stringliteral">                        FROM "</span>.$dbprefix.<span class="stringliteral">"users</span>
<a name="l00167"></a>00167 <span class="stringliteral">                       WHERE username='$username'</span>
<a name="l00168"></a>00168 <span class="stringliteral">                         AND password='$passwd'"</span>;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">//            debug_sql($sqlQuery);</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172          <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=$database-&gt;openConnectionWithReturn($sqlQuery);
<a name="l00173"></a>00173          <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)!=0){
<a name="l00174"></a>00174 
<a name="l00175"></a>00175             list($uid, $gid, $block, $usertype)=mysql_fetch_array(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">//               debug_sql("$uid, $gid, $block, $usertype",'user found');</span>
<a name="l00178"></a>00178 
<a name="l00179"></a>00179             <span class="keywordflow">if</span> ($block == 1){
<a name="l00180"></a>00180                <span class="comment">//               $this-&gt;recordLogin($uid, $username, "blocked", $database, $dbprefix); //Added by fnacer 4/27/03</span>
<a name="l00181"></a>00181                <span class="comment">//echo "&lt;SCRIPT&gt;alert(\""._LOGIN_BLOCKED."\"); window.history.go(-1); &lt;/SCRIPT&gt;\n";</span>
<a name="l00182"></a>00182                $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlLoginFailed.<span class="stringliteral">"&amp;msg=_LOGIN_BLOCKED"</span>);
<a name="l00183"></a>00183             }<span class="keywordflow">else</span>{
<a name="l00184"></a>00184                <span class="comment">//recordLogin($uid, $username, "login", $database, $dbprefix); //Added by fnacer 4/27/03</span>
<a name="l00185"></a>00185                <span class="comment">//               $firstLogin=$this-&gt;recordLogin($uid, $username, "login", $database, $dbprefix); //Added by fnacer 4/27/03</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187                <span class="comment">//               debug_sql('user is not blocked');</span>
<a name="l00188"></a>00188                <span class="comment">//               debug_obj($_SESSION,'$_SESSION');</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190                <span class="comment">//session exist</span>
<a name="l00191"></a>00191                <span class="keywordflow">if</span> ($_SESSION[<span class="stringliteral">"sessioncookie"</span>]!=<span class="stringliteral">""</span>){
<a name="l00192"></a>00192                   <span class="comment">//                  debug_sql('sessioncookie is NOT null');</span>
<a name="l00193"></a>00193                   <span class="comment">//if ($_COOKIE["sessioncookie"]!=""){</span>
<a name="l00194"></a>00194                   <span class="comment">//        if ($_SESSION["sessioncookie"]!=""){</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                   $sessionID=$_SESSION[<span class="stringliteral">"sessioncookie"</span>];
<a name="l00197"></a>00197                   <span class="comment">//                  $sessionID=$_COOKIE["sessioncookie"];</span>
<a name="l00198"></a>00198                   <span class="comment">//$sessionID=$_SESSION["sessioncookie"];</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                   <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT session_id</span>
<a name="l00202"></a>00202 <span class="stringliteral">                            FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00203"></a>00203 <span class="stringliteral">                           WHERE session_id='$cryptSessionID'"</span>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205                   <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=$database-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00206"></a>00206                   <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0){
<a name="l00207"></a>00207                      <span class="comment">//No session Exist Create new</span>
<a name="l00208"></a>00208                      <span class="comment">//                     debug_sql('No DB session Exist Create new');</span>
<a name="l00209"></a>00209                      $existSessionID=0;
<a name="l00210"></a>00210                      <span class="keywordflow">while</span> ($existSessionID==0){
<a name="l00211"></a>00211                         $sessionID=$this-&gt;<a class="code" href="classLogger.html#e8497dfa975e2c955f7eb17fc07bff27">getSessionID</a>();
<a name="l00212"></a>00212                         <span class="keywordflow">if</span> ($sessionID!=<span class="stringliteral">""</span>){
<a name="l00213"></a>00213                            $cryptSessionID=md5($sessionID);
<a name="l00214"></a>00214                            <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT session_id</span>
<a name="l00215"></a>00215 <span class="stringliteral">                                     FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00216"></a>00216 <span class="stringliteral">                                    WHERE session_id='$cryptSessionID'"</span>;
<a name="l00217"></a>00217                            <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=$database-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00218"></a>00218                            <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0){
<a name="l00219"></a>00219                               $existSessionID=1;
<a name="l00220"></a>00220                            }
<a name="l00221"></a>00221                         }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223                         <span class="keywordflow">if</span> ($existSessionID==1){
<a name="l00224"></a>00224                            <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"INSERT into "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00225"></a>00225 <span class="stringliteral">                      SET session_id='$cryptSessionID',</span>
<a name="l00226"></a>00226 <span class="stringliteral">                            guest='',</span>
<a name="l00227"></a>00227 <span class="stringliteral">                        userid='$uid',</span>
<a name="l00228"></a>00228 <span class="stringliteral">                          usertype='$usertype',</span>
<a name="l00229"></a>00229 <span class="stringliteral">                      gid='$gid',</span>
<a name="l00230"></a>00230 <span class="stringliteral">                      username='$username'"</span>;
<a name="l00231"></a>00231                            $database-&gt;openConnectionNoReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                            <span class="comment">//                           setcookie("sessioncookie", "$sessionID");</span>
<a name="l00234"></a>00234                            <span class="comment">//setcookie("sessioncookie", "$sessionID",0,LIVE_SITE_COOKIE_PATH,LIVE_SITE_COOKIE);</span>
<a name="l00235"></a>00235                            $_SESSION['sessioncookie'] = $sessionID;
<a name="l00236"></a>00236                            $sessioncookie=$sessionID;
<a name="l00237"></a>00237                         }
<a name="l00238"></a>00238                      }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240                   }<span class="keywordflow">else</span>{
<a name="l00241"></a>00241                      $cryptSessionID=md5($sessionID);
<a name="l00242"></a>00242                      <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"UPDATE "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00243"></a>00243 <span class="stringliteral">                        SET guest=0,</span>
<a name="l00244"></a>00244 <span class="stringliteral">                      username='$username',</span>
<a name="l00245"></a>00245 <span class="stringliteral">                      userid='$uid',</span>
<a name="l00246"></a>00246 <span class="stringliteral">                      usertype='$usertype' ,</span>
<a name="l00247"></a>00247 <span class="stringliteral">                      gid='$gid'</span>
<a name="l00248"></a>00248 <span class="stringliteral">                      WHERE session_id='$cryptSessionID'"</span>;
<a name="l00249"></a>00249                      $database-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00250"></a>00250                   }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252                }<span class="keywordflow">else</span>{
<a name="l00253"></a>00253                   $existSessionID=0;
<a name="l00254"></a>00254                   <span class="keywordflow">while</span> ($existSessionID==0){
<a name="l00255"></a>00255                      $sessionID=$this-&gt;<a class="code" href="classLogger.html#e8497dfa975e2c955f7eb17fc07bff27">getSessionID</a>();
<a name="l00256"></a>00256                      <span class="keywordflow">if</span> ($sessionID!=<span class="stringliteral">""</span>){
<a name="l00257"></a>00257                         $cryptSessionID=md5($sessionID);
<a name="l00258"></a>00258                         <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT session_id</span>
<a name="l00259"></a>00259 <span class="stringliteral">                    FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00260"></a>00260 <span class="stringliteral">                   where session_id='$cryptSessionID'"</span>;
<a name="l00261"></a>00261                         <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=$database-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00262"></a>00262                         <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0){
<a name="l00263"></a>00263                            $existSessionID=1;
<a name="l00264"></a>00264                         }
<a name="l00265"></a>00265                      }
<a name="l00266"></a>00266                   }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268                   <span class="keywordflow">if</span> ($existSessionID==1){
<a name="l00269"></a>00269                      <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"INSERT into "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00270"></a>00270 <span class="stringliteral">                  set session_id='$cryptSessionID',</span>
<a name="l00271"></a>00271 <span class="stringliteral">                      guest='',</span>
<a name="l00272"></a>00272 <span class="stringliteral">                      userid='$uid',</span>
<a name="l00273"></a>00273 <span class="stringliteral">                      usertype='$usertype',</span>
<a name="l00274"></a>00274 <span class="stringliteral">                      gid='$gid',</span>
<a name="l00275"></a>00275 <span class="stringliteral">                      username='$username'"</span>;
<a name="l00276"></a>00276                      $database-&gt;openConnectionNoReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278                      $_SESSION['sessioncookie'] = $sessionID;
<a name="l00279"></a>00279                      $sessioncookie = $sessionID;
<a name="l00280"></a>00280                   }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282                }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284                $lifetime= (time() + 43200);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286                $_SESSION[<span class="stringliteral">"usercookie"</span>] = $sessionID;
<a name="l00287"></a>00287                $usercookie=$sessionID;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                $this-&gt;bLogged           = <span class="keyword">true</span>;
<a name="l00290"></a>00290                $this-&gt;lUserId           = $uid;
<a name="l00291"></a>00291                $this-&gt;lUserType         = $gid;
<a name="l00292"></a>00292                $this-&gt;_UserTypeString   = $usertype;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294                $this-&gt;strUserNick = $username;
<a name="l00295"></a>00295                <span class="keywordflow">if</span> ($this-&gt;lUserType == 2) {
<a name="l00296"></a>00296                   $this-&gt;bAdmin = <span class="keyword">true</span>;
<a name="l00297"></a>00297                }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299                $this-&gt;_bJustLogged = <span class="keyword">true</span>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                $_SESSION['oLogger'] = $this;
<a name="l00302"></a>00302                <span class="comment">//print "&lt;SCRIPT&gt;document.location.href='index.php?option=$option'&lt;/SCRIPT&gt;\n";</span>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                <span class="comment">//echo "firstLogin:".$firstLogin;</span>
<a name="l00305"></a>00305                <span class="comment">//die;</span>
<a name="l00306"></a>00306                <span class="comment">//kupriyanov.de</span>
<a name="l00307"></a>00307                <span class="keywordflow">if</span> ($firstLogin==1){
<a name="l00308"></a>00308                   <span class="comment">//echo "&lt;SCRIPT&gt;document.location.href = 'index.php?option=user&amp;op=ud_ab'; &lt;/SCRIPT&gt;\n";</span>
<a name="l00309"></a>00309                   <span class="comment">//$this-&gt;relocate(LIVE_SITE_URL."/index.php?option=user&amp;op=ud_ab");</span>
<a name="l00310"></a>00310                   $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlLoginSuccess.<span class="stringliteral">"&amp;info=firstLogin"</span>);
<a name="l00311"></a>00311                }<span class="keywordflow">else</span>{
<a name="l00312"></a>00312                   <span class="comment">//print "&lt;SCRIPT&gt;document.location.href='index.php?option=$option'&lt;/SCRIPT&gt;\n";</span>
<a name="l00313"></a>00313                   $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlLoginSuccess);
<a name="l00314"></a>00314                }
<a name="l00315"></a>00315                <span class="comment">//-----------------------</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317             }
<a name="l00318"></a>00318          }<span class="keywordflow">else</span>{
<a name="l00319"></a>00319             <span class="comment">//            $this-&gt;recordLogin(0, $username, "failed", $database, $dbprefix); //Added by fnacer 4/27/03</span>
<a name="l00320"></a>00320             <span class="comment">//echo "&lt;SCRIPT&gt;alert(\""._LOGIN_INCORRECT."\"); window.history.go(-1); &lt;/SCRIPT&gt;\n";</span>
<a name="l00321"></a>00321             $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlLoginFailed.<span class="stringliteral">"&amp;msg=_LOGIN_INCORRECT"</span>);
<a name="l00322"></a>00322          }
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324    }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="comment">//Start of code Added by fnacer 4/27/03 ----------------------------------------------------------------</span>
<a name="l00338"></a><a class="code" href="classLogger.html#ba0a8c015b79271c9b3b0e5e52b5699c">00338</a> <span class="comment"></span>   function <a class="code" href="classLogger.html#ba0a8c015b79271c9b3b0e5e52b5699c">recordLogin</a>($uid, $username, $logintype, <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>, $dbprefix){
<a name="l00339"></a>00339       $firstLogin=0;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       define(DEFAULT_CREATED,'1/1/1980');
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       <span class="keywordflow">if</span> (<a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a> == null){
<a name="l00344"></a>00344          <span class="keywordflow">if</span>(!class_exists(<span class="stringliteral">"database"</span>)){
<a name="l00345"></a>00345             include_once(<a class="code" href="configuration_8php.html#4617283702a69a0d5ee6d9797672e391">CLASSES_PATH</a>.<span class="stringliteral">"/database.php"</span>);
<a name="l00346"></a>00346          }
<a name="l00347"></a>00347          <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a> = <span class="keyword">new</span> <a class="code" href="classdatabase.html">database</a>();
<a name="l00348"></a>00348          $this-&gt;<a class="code" href="classdatabase.html">database</a> =&amp; <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>;
<a name="l00349"></a>00349       }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351       <span class="keywordflow">if</span> ($uid==0){
<a name="l00352"></a>00352          <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT id from "</span>.$dbprefix.<span class="stringliteral">"users where username='$username'"</span>;
<a name="l00353"></a>00353          <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00354"></a>00354          <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)!=0) list($uid)=mysql_fetch_array(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00355"></a>00355       } <span class="keywordflow">else</span> {
<a name="l00356"></a>00356          <span class="comment">//$query="SELECT id from ".$dbprefix."users2 where uid=$uid";</span>
<a name="l00357"></a>00357          <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"SELECT id, logincount from "</span>.$dbprefix.<span class="stringliteral">"users2 where uid=$uid"</span>;
<a name="l00358"></a>00358          <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>=<a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>-&gt;openConnectionWithReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00359"></a>00359          list($id,$logincount)=mysql_fetch_array(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00360"></a>00360          <span class="keywordflow">if</span> (mysql_num_rows(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)==0){
<a name="l00361"></a>00361             <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"INSERT INTO "</span>.$dbprefix.<span class="stringliteral">"users2 (uid, created) VALUES ($uid,0)"</span>;
<a name="l00362"></a>00362             <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>-&gt;openConnectionNoReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00363"></a>00363          }<span class="keywordflow">else</span>{
<a name="l00364"></a>00364             <span class="keywordflow">if</span> ($logincount==0) $firstLogin=1;
<a name="l00365"></a>00365          }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367          <span class="comment">//   echo "logincount:".$logincount;</span>
<a name="l00368"></a>00368          <span class="comment">//   echo "firstLogin:".$firstLogin;</span>
<a name="l00369"></a>00369          <span class="comment">//die;</span>
<a name="l00370"></a>00370       }
<a name="l00371"></a>00371       <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a> = <span class="stringliteral">""</span>;
<a name="l00372"></a>00372       <span class="keywordflow">switch</span> ($logintype){
<a name="l00373"></a>00373          <span class="keywordflow">case</span> <span class="stringliteral">"blocked"</span>:
<a name="l00374"></a>00374             <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"UPDATE "</span>.$dbprefix.<span class="stringliteral">"users2 SET lastblockedlogin=now(), blockedlogincount=blockedlogincount+1 WHERE uid=$uid"</span>;
<a name="l00375"></a>00375             <span class="keywordflow">break</span>;
<a name="l00376"></a>00376          <span class="keywordflow">case</span> <span class="stringliteral">"login"</span>:
<a name="l00377"></a>00377             <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"UPDATE "</span>.$dbprefix.<span class="stringliteral">"users2 SET lastlogin=now(), logincount=logincount+1 WHERE uid=$uid"</span>;
<a name="l00378"></a>00378             <span class="keywordflow">break</span>;
<a name="l00379"></a>00379          <span class="keywordflow">case</span> <span class="stringliteral">"failed"</span>:
<a name="l00380"></a>00380             <span class="keywordflow">if</span> ($uid!=0) <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"UPDATE "</span>.$dbprefix.<span class="stringliteral">"users2 SET lastfailedlogin=now(), failedlogincount=failedlogincount+1 WHERE uid=$uid"</span>;
<a name="l00381"></a>00381             <span class="keywordflow">break</span>;
<a name="l00382"></a>00382          <span class="keywordflow">default</span>:
<a name="l00383"></a>00383       }
<a name="l00384"></a>00384       <span class="keywordflow">if</span> (<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>!=<span class="stringliteral">""</span>) <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>-&gt;openConnectionNoReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386       <span class="keywordflow">return</span> $firstLogin;
<a name="l00387"></a>00387    }
<a name="l00388"></a>00388    <span class="comment">//End of code Added by fnacer 4/27/03 -----------------------------------------------------------------</span>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 
<a name="l00396"></a><a class="code" href="classLogger.html#e8497dfa975e2c955f7eb17fc07bff27">00396</a>    function <a class="code" href="classLogger.html#e8497dfa975e2c955f7eb17fc07bff27">getSessionID</a>(){
<a name="l00397"></a>00397       mt_srand ((<span class="keywordtype">double</span>) microtime() * 1000000);
<a name="l00398"></a>00398       $pass_len = mt_rand (20,40);
<a name="l00399"></a>00399       $allchar = <span class="stringliteral">"abcdefghijklnmopqrstuvwxyzABCDEFGHIJKLNMOPQRSTUVWXYZ0123456789"</span>;
<a name="l00400"></a>00400       $str = <span class="stringliteral">""</span> ;
<a name="l00401"></a>00401       <span class="keywordflow">for</span> ( $i = 0; $i&lt;$pass_len ; $i++ ){
<a name="l00402"></a>00402          $str .= substr( $allchar, mt_rand (0,62), 1 ) ;
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404       $timestamp= time();
<a name="l00405"></a>00405       $str=$str.$timestamp;
<a name="l00406"></a>00406       <span class="keywordflow">return</span>($str);
<a name="l00407"></a>00407    }
<a name="l00408"></a>00408 
<a name="l00414"></a><a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">00414</a>    function <a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($url){
<a name="l00415"></a>00415       <span class="comment">//      debug_sql(SMARTY_DEBUG,'SMARTY_DEBUG');</span>
<a name="l00416"></a>00416       <span class="keywordflow">if</span> (<a class="code" href="configuration_8local_8php.html#886b95b1f12aacfdbc45a98920cde809">SMARTY_DEBUG</a>){
<a name="l00417"></a>00417          <span class="keywordflow">if</span>(headers_sent()){
<a name="l00418"></a>00418             echo <span class="stringliteral">"WARNING: Headers has been already sent [&lt;a href='$url'&gt;$url&lt;/a&gt;]"</span>;
<a name="l00419"></a>00419             print_r('&lt;pre&gt;');
<a name="l00420"></a>00420             print_r(debug_backtrace());
<a name="l00421"></a>00421          }<span class="keywordflow">else</span>{
<a name="l00422"></a>00422             header(<span class="stringliteral">"Location: "</span>.$url);
<a name="l00423"></a>00423          }
<a name="l00424"></a>00424          die();
<a name="l00425"></a>00425       }<span class="keywordflow">else</span>{
<a name="l00426"></a>00426          <span class="keywordflow">if</span>(headers_sent()){
<a name="l00427"></a>00427             echo <span class="stringliteral">"WARNING: Headers has been already sent. Try to click here [&lt;a href='$url'&gt;$url&lt;/a&gt;]"</span>;
<a name="l00428"></a>00428          }<span class="keywordflow">else</span>{
<a name="l00429"></a>00429             header(<span class="stringliteral">"Location: "</span>.$url);
<a name="l00430"></a>00430          }
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432       <span class="comment">//echo "Location: ".$url;</span>
<a name="l00433"></a>00433 <span class="comment">//      header("Location: ".$url);</span>
<a name="l00434"></a>00434 <span class="comment">//      die();</span>
<a name="l00435"></a>00435    }
<a name="l00436"></a>00436 
<a name="l00442"></a><a class="code" href="classLogger.html#1aec7b983a33742c7d467bedbe73c94d">00442</a>    function <a class="code" href="classLogger.html#1aec7b983a33742c7d467bedbe73c94d">doLogout</a>($urlSuccess = null){
<a name="l00443"></a>00443       global $_COOKIE,$dbprefix,<a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>,<a class="code" href="SessionCookie_8php.html#93d36a95c848bb1af38554eb7ecd6174">$_SESSION</a>;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <span class="keywordflow">if</span> ($database == null){
<a name="l00446"></a>00446          <span class="keywordflow">if</span>(!class_exists(<span class="stringliteral">"database"</span>)){
<a name="l00447"></a>00447             include_once(<a class="code" href="configuration_8php.html#4617283702a69a0d5ee6d9797672e391">CLASSES_PATH</a>.<span class="stringliteral">"/database.php"</span>);
<a name="l00448"></a>00448          }
<a name="l00449"></a>00449          $database = <span class="keyword">new</span> <a class="code" href="classdatabase.html">database</a>();
<a name="l00450"></a>00450          $this-&gt;<a class="code" href="classdatabase.html">database</a> =&amp; $database;
<a name="l00451"></a>00451       }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453       <span class="comment">//      $cryptSessionCookie=md5($_COOKIE["sessioncookie"]);</span>
<a name="l00454"></a>00454       $cryptSessionCookie=md5($_SESSION[<span class="stringliteral">"sessioncookie"</span>]);
<a name="l00455"></a>00455       <span class="comment">//      $cryptSessionCookie=md5($_SESSION["sessioncookie"]);</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457       <span class="keywordflow">if</span> ($database==null){
<a name="l00458"></a>00458          $database = <span class="keyword">new</span> <a class="code" href="classdatabase.html">database</a>();
<a name="l00459"></a>00459       }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461       <a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>=<span class="stringliteral">"UPDATE "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00462"></a>00462 <span class="stringliteral">             SET guest=1, username='', userid='', usertype='', gid=''</span>
<a name="l00463"></a>00463 <span class="stringliteral">           WHERE session_id='$cryptSessionCookie'"</span>;
<a name="l00464"></a>00464       $database-&gt;openConnectionNoReturn(<a class="code" href="SessionCookie_8php.html#f59a5f7cd609e592c41dc3643efd3c98">$query</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466       <span class="comment">//      setcookie("usercookie", "");</span>
<a name="l00467"></a>00467       <span class="comment">//      setcookie("sessioncookie", "");</span>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469       <span class="comment">//      setcookie("usercookie", "",0,LIVE_SITE_COOKIE_PATH,LIVE_SITE_COOKIE);</span>
<a name="l00470"></a>00470       <span class="comment">//      setcookie("sessioncookie", "",0,LIVE_SITE_COOKIE_PATH,LIVE_SITE_COOKIE);</span>
<a name="l00471"></a>00471       <span class="comment">//</span>
<a name="l00472"></a>00472       <span class="comment">//      $_SESSION["usercookie"] = "expired";</span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474       $_SESSION['usercookie']    = '';
<a name="l00475"></a>00475       <span class="comment">//$_SESSION['sessioncookie'] = '';</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477       $this-&gt;bLogged   = <span class="keyword">false</span>;
<a name="l00478"></a>00478       $this-&gt;lUserId   = 0;
<a name="l00479"></a>00479       $this-&gt;lUserType = 0;
<a name="l00480"></a>00480       $this-&gt;_UserTypeString = '';
<a name="l00481"></a>00481 
<a name="l00482"></a>00482       <span class="comment">//      unset($this-&gt;lUserId);</span>
<a name="l00483"></a>00483       <span class="comment">//      unset($this-&gt;lUserType);</span>
<a name="l00484"></a>00484       unset($this-&gt;bAdmin);
<a name="l00485"></a>00485       unset($this-&gt;strUserNick);
<a name="l00486"></a>00486       $_SESSION[<span class="stringliteral">"oLogger"</span>] = $this;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488       <span class="keywordflow">if</span> ($urlSuccess!=<span class="stringliteral">""</span>){
<a name="l00489"></a>00489          <span class="comment">//echo "Location: ".$urlSuccess;</span>
<a name="l00490"></a>00490          $this-&gt;<a class="code" href="classLogger.html#6b92de453637ba381f6b38af128677d8">relocate</a>($urlSuccess);
<a name="l00491"></a>00491       }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494 
<a name="l00500"></a><a class="code" href="classLogger.html#5be6c3da0a1dbb66eed287f9e29cc6e5">00500</a>    function <a class="code" href="classLogger.html#5be6c3da0a1dbb66eed287f9e29cc6e5">IsJustLogged</a>(){
<a name="l00501"></a>00501       <span class="keywordflow">if</span>($this-&gt;_bJustLogged){
<a name="l00502"></a>00502          $this-&gt;_bJustLogged = <span class="keyword">false</span>;
<a name="l00503"></a>00503          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00504"></a>00504       }<span class="keywordflow">else</span>{
<a name="l00505"></a>00505          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00506"></a>00506       }
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508 
<a name="l00517"></a><a class="code" href="classLogger.html#531acb23b4cd12bb71f33e2327def989">00517</a>    function <a class="code" href="classLogger.html#531acb23b4cd12bb71f33e2327def989">checkaccess</a>($cook, <a class="code" href="configuration_8db_8php.html#1fa3127fc82f96b1436d871ef02be319">$db</a>, $dbprefix){
<a name="l00518"></a>00518       global <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>,$dbprefix;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520       <span class="comment">/* Get the visitor's GroupID */</span>
<a name="l00521"></a>00521       $gidf = 0;
<a name="l00522"></a>00522       <span class="keywordflow">if</span> ($cook&lt;&gt;<span class="stringliteral">""</span>){
<a name="l00523"></a>00523          $cryptSessionID=md5($cook);
<a name="l00524"></a>00524          $queryg = <span class="stringliteral">"SELECT gid</span>
<a name="l00525"></a>00525 <span class="stringliteral">            FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00526"></a>00526 <span class="stringliteral">           WHERE session_ID='$cryptSessionID'"</span>;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528          <span class="comment">//$resultg = mysql_db_query($db, $queryg) or die("Did not execute query");</span>
<a name="l00529"></a>00529          $resultg = $database-&gt;openConnectionWithReturn($queryg);
<a name="l00530"></a>00530          <span class="keywordflow">while</span> ($rowg = mysql_fetch_object($resultg)){
<a name="l00531"></a>00531             $gidf = $rowg-&gt;gid;
<a name="l00532"></a>00532          }
<a name="l00533"></a>00533       }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classLogger.html#ccd790e245f1f00eebba7c18e1ec16fa">IsLogged</a>() &amp;&amp; $gidf==0){
<a name="l00537"></a>00537          $this-&gt;<a class="code" href="classLogger.html#1aec7b983a33742c7d467bedbe73c94d">doLogout</a>();
<a name="l00538"></a>00538       }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540       <span class="comment">//      debug_sql($gidf,'$gidf');</span>
<a name="l00541"></a>00541       <span class="keywordflow">return</span> $gidf;
<a name="l00542"></a>00542    }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 
<a name="l00554"></a><a class="code" href="classLogger.html#3d4c0e693f4e76414e723a5eebd802f8">00554</a>    function <a class="code" href="classLogger.html#3d4c0e693f4e76414e723a5eebd802f8">checkaccess_uid</a>($cook, <a class="code" href="configuration_8db_8php.html#1fa3127fc82f96b1436d871ef02be319">$db</a>, $dbprefix){
<a name="l00555"></a>00555       global <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>,$dbprefix;
<a name="l00556"></a>00556       <span class="comment">/* Get the visitor's GroupID */</span>
<a name="l00557"></a>00557       $useridf = 0;
<a name="l00558"></a>00558       <span class="keywordflow">if</span> ($cook&lt;&gt;<span class="stringliteral">""</span>){
<a name="l00559"></a>00559          $cryptSessionID=md5($cook);
<a name="l00560"></a>00560          $queryg = <span class="stringliteral">"SELECT gid,</span>
<a name="l00561"></a>00561 <span class="stringliteral">                 userid</span>
<a name="l00562"></a>00562 <span class="stringliteral">            FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00563"></a>00563 <span class="stringliteral">             WHERE session_ID='$cryptSessionID'"</span>;
<a name="l00564"></a>00564          <span class="comment">//         $resultg = mysql_db_query($db, $queryg) or die("Did not execute query");</span>
<a name="l00565"></a>00565          $resultg = $database-&gt;openConnectionWithReturn($queryg);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567          <span class="keywordflow">while</span> ($rowg = mysql_fetch_object($resultg)){
<a name="l00568"></a>00568             $gidf    = $rowg-&gt;gid;
<a name="l00569"></a>00569             $useridf = $rowg-&gt;userid;
<a name="l00570"></a>00570          }
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classLogger.html#ccd790e245f1f00eebba7c18e1ec16fa">IsLogged</a>() &amp;&amp; $useridf==0){
<a name="l00574"></a>00574          $this-&gt;<a class="code" href="classLogger.html#1aec7b983a33742c7d467bedbe73c94d">doLogout</a>();
<a name="l00575"></a>00575       }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="comment">//      debug_sql($useridf,'$useridf');</span>
<a name="l00578"></a>00578       <span class="keywordflow">return</span> $useridf;
<a name="l00579"></a>00579    }
<a name="l00580"></a>00580 
<a name="l00588"></a><a class="code" href="classLogger.html#f71a9303af62b50d37df2be57596daee">00588</a>    function <a class="code" href="classLogger.html#f71a9303af62b50d37df2be57596daee">checkIfUserLoggedByNick</a>($userNick = null,&amp;$userId){
<a name="l00589"></a>00589       global $dbprefix, <a class="code" href="classLogger.html#99e7dc3dcb61e07f44a96556c4f29823">$database</a>;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591       $this-&gt;lastError = null;
<a name="l00592"></a>00592       $userId = null;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594       <span class="keywordflow">if</span>($userNick == null){
<a name="l00595"></a>00595          $this-&gt;lastError = ERROR_REQUIRED_INPUT_USERNICK_IS_NULL;
<a name="l00596"></a>00596          <span class="keywordflow">return</span> null;
<a name="l00597"></a>00597       }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="comment">//      echo "1156112240&lt;br&gt;";</span>
<a name="l00601"></a>00601       <span class="comment">//      echo time()."&lt;br&gt;";</span>
<a name="l00602"></a>00602       <span class="comment">//      echo (time()+30*60)."&lt;br&gt;";</span>
<a name="l00603"></a>00603       <span class="comment">//      $nextWeek = time() + (7 * 24 * 60 * 60);</span>
<a name="l00604"></a>00604       <span class="comment">//                   // 7 days; 24 hours; 60 mins; 60secs</span>
<a name="l00605"></a>00605       <span class="comment">//</span>
<a name="l00606"></a>00606       <span class="comment">//      echo 'Next Week: '. date('Y-m-d H:i:s', "1156112240") ."&lt;br&gt;\n";</span>
<a name="l00607"></a>00607       <span class="comment">//      echo 'Next Week: '. date('Y-m-d H:i:s', (1156112240+30*60)) ."&lt;br&gt;\n";</span>
<a name="l00608"></a>00608       <span class="comment">//      echo 'Next Week: '. date('Y-m-d H:i:s', time()) ."&lt;br&gt;\n";</span>
<a name="l00609"></a>00609       <span class="comment">//      die();</span>
<a name="l00610"></a>00610 
<a name="l00611"></a>00611       $sqlQuery = <span class="stringliteral">"SELECT userid</span>
<a name="l00612"></a>00612 <span class="stringliteral">                     FROM "</span>.$dbprefix.<span class="stringliteral">"session</span>
<a name="l00613"></a>00613 <span class="stringliteral">                     WHERE username LIKE '"</span>.$userNick.<span class="stringliteral">"'</span>
<a name="l00614"></a>00614 <span class="stringliteral">                       AND time &gt; "</span>.(time()-30*60);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616       <span class="comment">//      debug_sql($sqlQuery);</span>
<a name="l00617"></a>00617 
<a name="l00618"></a>00618       <a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a> = $database-&gt;openConnectionWithReturn($sqlQuery);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620       <span class="keywordflow">if</span> ($userInfo = mysql_fetch_array(<a class="code" href="SessionCookie_8php.html#112ef069ddc0454086e3d1e6d8d55d07">$result</a>)){
<a name="l00621"></a>00621          $userId = $userInfo['userid'];
<a name="l00622"></a>00622          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00623"></a>00623       }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    }
<a name="l00628"></a>00628 
<a name="l00634"></a><a class="code" href="classLogger.html#ccd790e245f1f00eebba7c18e1ec16fa">00634</a>    function <a class="code" href="classLogger.html#ccd790e245f1f00eebba7c18e1ec16fa">IsLogged</a>(){
<a name="l00635"></a>00635       <span class="keywordflow">return</span> $this-&gt;bLogged;
<a name="l00636"></a>00636    }
<a name="l00637"></a>00637 
<a name="l00643"></a><a class="code" href="classLogger.html#e514a275833d21265fbb7e71dae4691d">00643</a>    function <a class="code" href="classLogger.html#e514a275833d21265fbb7e71dae4691d">IsAdmin</a>(){
<a name="l00644"></a>00644       <span class="keywordflow">return</span> $this-&gt;bAdmin;
<a name="l00645"></a>00645    }
<a name="l00646"></a>00646 
<a name="l00650"></a><a class="code" href="classLogger.html#d9e8f8aca72ea33246995c16eb0c3360">00650</a>    function <a class="code" href="classLogger.html#d9e8f8aca72ea33246995c16eb0c3360">getUserId</a>(){
<a name="l00651"></a>00651       <span class="keywordflow">return</span> $this-&gt;lUserId;
<a name="l00652"></a>00652    }
<a name="l00653"></a>00653 
<a name="l00659"></a><a class="code" href="classLogger.html#92daff3aaf468c94e27dbede71120bfd">00659</a>    function <a class="code" href="classLogger.html#92daff3aaf468c94e27dbede71120bfd">getUserNick</a>(){
<a name="l00660"></a>00660       <span class="keywordflow">return</span> $this-&gt;strUserNick;
<a name="l00661"></a>00661    }
<a name="l00662"></a>00662 
<a name="l00668"></a><a class="code" href="classLogger.html#fdf7141666436b3136e1b1f844fe6321">00668</a>    function <a class="code" href="classLogger.html#fdf7141666436b3136e1b1f844fe6321">getUserType</a>(){
<a name="l00669"></a>00669       <span class="keywordflow">return</span> $this-&gt;lUserType;
<a name="l00670"></a>00670    }
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 ?&gt;
</pre></div><hr size="1"><address style="text-align: right;"><small>Erzeugt am Fri Dec 7 10:25:12 2007 für mkSurvey von&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
