<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>mkSurvey: hn_captcha.class.php Quellcode</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Erzeugt von Doxygen 1.5.4 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Hauptseite</span></a></li>
    <li><a href="namespaces.html"><span>Pakete</span></a></li>
    <li><a href="annotated.html"><span>Klassen</span></a></li>
    <li class="current"><a href="files.html"><span>Dateien</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>uchen&nbsp;nach&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<h1>hn_captcha.class.php</h1><a href="hn__captcha_8class_8php.html">gehe zur Dokumentation dieser Datei</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00099"></a><a class="code" href="classhn__captcha.html">00099</a> <span class="keyword">class </span><a class="code" href="classhn__captcha.html">hn_captcha</a>
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101 
<a name="l00103"></a>00103    <span class="comment">//</span>
<a name="l00104"></a>00104    <span class="comment">//   PUBLIC PARAMS</span>
<a name="l00105"></a>00105    <span class="comment">//</span>
<a name="l00106"></a>00106 
<a name="l00113"></a><a class="code" href="classhn__captcha.html#20707c72489923ac994201ed3b6040a2">00113</a>    var <a class="code" href="classhn__captcha.html#20707c72489923ac994201ed3b6040a2">$tempfolder</a>;
<a name="l00114"></a>00114 
<a name="l00121"></a><a class="code" href="classhn__captcha.html#05e45f077bbdd3eeeff3268d1094b252">00121</a>    var <a class="code" href="classhn__captcha.html#05e45f077bbdd3eeeff3268d1094b252">$TTF_folder</a>;
<a name="l00122"></a>00122 
<a name="l00129"></a><a class="code" href="classhn__captcha.html#0d5726c70d35cde60709054faf23c6e3">00129</a>    var <a class="code" href="classhn__captcha.html#0d5726c70d35cde60709054faf23c6e3">$TTF_RANGE</a>  = array('COMIC.TTF<span class="charliteral">','</span>JACOBITE.TTF<span class="charliteral">','</span>LYDIAN.TTF<span class="charliteral">','</span>MREARL.TTF<span class="charliteral">','</span>RUBBERSTAMP.TTF<span class="charliteral">','</span>ZINJARON.TTF');
<a name="l00130"></a>00130 
<a name="l00137"></a><a class="code" href="classhn__captcha.html#6ff5076007ab194575ecc7569a21ea47">00137</a>    var <a class="code" href="classhn__captcha.html#6ff5076007ab194575ecc7569a21ea47">$chars</a>           = 6;
<a name="l00138"></a>00138 
<a name="l00145"></a><a class="code" href="classhn__captcha.html#ff43c3b01a2dc6e238f1fbdfe29e5207">00145</a>    var <a class="code" href="classhn__captcha.html#ff43c3b01a2dc6e238f1fbdfe29e5207">$minsize</a> = 20;
<a name="l00146"></a>00146 
<a name="l00153"></a><a class="code" href="classhn__captcha.html#e86c5725f0ecb02014a46297012b4fe7">00153</a>    var <a class="code" href="classhn__captcha.html#e86c5725f0ecb02014a46297012b4fe7">$maxsize</a> = 40;
<a name="l00154"></a>00154 
<a name="l00161"></a><a class="code" href="classhn__captcha.html#1e62c2f5c87816054f68ccfbfa946419">00161</a>    var <a class="code" href="classhn__captcha.html#1e62c2f5c87816054f68ccfbfa946419">$maxrotation</a> = 30;
<a name="l00162"></a>00162 
<a name="l00169"></a><a class="code" href="classhn__captcha.html#24c82e2be511458b971f43085a87cc6f">00169</a>    var <a class="code" href="classhn__captcha.html#24c82e2be511458b971f43085a87cc6f">$noise</a>           = TRUE;
<a name="l00170"></a>00170 
<a name="l00177"></a><a class="code" href="classhn__captcha.html#65b382ceb2365310ff70e835eb02fa7a">00177</a>    var <a class="code" href="classhn__captcha.html#65b382ceb2365310ff70e835eb02fa7a">$websafecolors</a> = FALSE;
<a name="l00178"></a>00178 
<a name="l00185"></a><a class="code" href="classhn__captcha.html#6ee872ba00cc1a1a88fd0b7b8ce4e822">00185</a>    var <a class="code" href="classhn__captcha.html#6ee872ba00cc1a1a88fd0b7b8ce4e822">$lang</a>            = <span class="stringliteral">"de"</span>;
<a name="l00186"></a>00186 
<a name="l00193"></a><a class="code" href="classhn__captcha.html#cf1fd31f07d8d8c2a11f7f023d962fe2">00193</a>    var <a class="code" href="classhn__captcha.html#cf1fd31f07d8d8c2a11f7f023d962fe2">$maxtry</a>          = 3;
<a name="l00194"></a>00194 
<a name="l00201"></a><a class="code" href="classhn__captcha.html#ee0ff19b5cfe2e952c21a9f658663188">00201</a>    var <a class="code" href="classhn__captcha.html#ee0ff19b5cfe2e952c21a9f658663188">$refreshlink</a> = TRUE;
<a name="l00202"></a>00202 
<a name="l00209"></a><a class="code" href="classhn__captcha.html#66d60513c390fbbc4cbba4dabaf2cdcc">00209</a>    var <a class="code" href="classhn__captcha.html#66d60513c390fbbc4cbba4dabaf2cdcc">$badguys_url</a> = <span class="stringliteral">"/"</span>;
<a name="l00210"></a>00210 
<a name="l00219"></a><a class="code" href="classhn__captcha.html#318f9dd2d53c7503f44cc72fb08ee188">00219</a>    var <a class="code" href="classhn__captcha.html#318f9dd2d53c7503f44cc72fb08ee188">$secretposition</a> = 21;
<a name="l00220"></a>00220 
<a name="l00227"></a><a class="code" href="classhn__captcha.html#d54f5ff45e92315101e371b67dbdd844">00227</a>    var <a class="code" href="classhn__captcha.html#d54f5ff45e92315101e371b67dbdd844">$secretstring</a> = <span class="stringliteral">"This is a very secret string. Nobody should know it, =:)"</span>;
<a name="l00228"></a>00228 
<a name="l00235"></a><a class="code" href="classhn__captcha.html#da6f7dc3cd5fa777dcd1a2fe481b310b">00235</a>    var <a class="code" href="classhn__captcha.html#da6f7dc3cd5fa777dcd1a2fe481b310b">$debug</a> = FALSE;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 
<a name="l00240"></a>00240    <span class="comment">//</span>
<a name="l00241"></a>00241    <span class="comment">//   PRIVATE PARAMS</span>
<a name="l00242"></a>00242    <span class="comment">//</span>
<a name="l00243"></a>00243 
<a name="l00245"></a><a class="code" href="classhn__captcha.html#3b55eec920145f3bd0f2523177a1d722">00245</a>    var <a class="code" href="classhn__captcha.html#3b55eec920145f3bd0f2523177a1d722">$lx</a>;                             <span class="comment">// width of picture</span>
<a name="l00247"></a><a class="code" href="classhn__captcha.html#8db9990332cb0d9ee4448a3370eb3100">00247</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#8db9990332cb0d9ee4448a3370eb3100">$ly</a>;                             <span class="comment">// height of picture</span>
<a name="l00249"></a><a class="code" href="classhn__captcha.html#63b3389be7b2c0de626b19f55f0cbe81">00249</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#63b3389be7b2c0de626b19f55f0cbe81">$jpegquality</a> = 80;       <span class="comment">// image quality</span>
<a name="l00251"></a><a class="code" href="classhn__captcha.html#54c238ea1772fabfe64fa41c9c889a18">00251</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#54c238ea1772fabfe64fa41c9c889a18">$noisefactor</a> = 9;        <span class="comment">// this will multiplyed with number of chars</span>
<a name="l00253"></a><a class="code" href="classhn__captcha.html#88697f55d769092356e7e44af5f8cd61">00253</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#88697f55d769092356e7e44af5f8cd61">$nb_noise</a>;                       <span class="comment">// number of background-noise-characters</span>
<a name="l00255"></a><a class="code" href="classhn__captcha.html#fc8660f66ec9f18dffebf2d65bd89d51">00255</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#fc8660f66ec9f18dffebf2d65bd89d51">$TTF_file</a>;                       <span class="comment">// holds the current selected TrueTypeFont</span>
<a name="l00257"></a><a class="code" href="classhn__captcha.html#79be175a9daf0d941641f570adf282b7">00257</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#79be175a9daf0d941641f570adf282b7">$msg1</a>;
<a name="l00259"></a><a class="code" href="classhn__captcha.html#52ad4e7fb39e62f18094b1b9ea8d247b">00259</a>    var <a class="code" href="classhn__captcha.html#52ad4e7fb39e62f18094b1b9ea8d247b">$msg2</a>;
<a name="l00261"></a><a class="code" href="classhn__captcha.html#55c161c9fc3b45860c41874824bafc09">00261</a>    var <a class="code" href="classhn__captcha.html#55c161c9fc3b45860c41874824bafc09">$buttontext</a>;
<a name="l00263"></a><a class="code" href="classhn__captcha.html#8eceea588697279839101cadaa983392">00263</a>    var <a class="code" href="classhn__captcha.html#8eceea588697279839101cadaa983392">$refreshbuttontext</a>;
<a name="l00265"></a><a class="code" href="classhn__captcha.html#95f7a0a7d451fdf779e570ede6272662">00265</a>    var <a class="code" href="classhn__captcha.html#95f7a0a7d451fdf779e570ede6272662">$public_K</a>;
<a name="l00267"></a><a class="code" href="classhn__captcha.html#1027e171948f8e5619193b5fcc824815">00267</a>    var <a class="code" href="classhn__captcha.html#1027e171948f8e5619193b5fcc824815">$private_K</a>;
<a name="l00269"></a><a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">00269</a>    var <a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">$key</a>;                            <span class="comment">// md5-key</span>
<a name="l00271"></a><a class="code" href="classhn__captcha.html#9c2cafa43b3806ef88fe0d799942fa36">00271</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#9c2cafa43b3806ef88fe0d799942fa36">$public_key</a>;     <span class="comment">// public key</span>
<a name="l00273"></a><a class="code" href="classhn__captcha.html#1ef754cd5a960c4c719becd1104a7b30">00273</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#1ef754cd5a960c4c719becd1104a7b30">$filename</a>;                       <span class="comment">// filename of captcha picture</span>
<a name="l00275"></a><a class="code" href="classhn__captcha.html#830262e4d8d78c99498c3fa03ef71b2d">00275</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#830262e4d8d78c99498c3fa03ef71b2d">$gd_version</a>;             <span class="comment">// holds the Version Number of GD-Library</span>
<a name="l00277"></a><a class="code" href="classhn__captcha.html#3445a958eb02a573c58f4dc67c64681b">00277</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#3445a958eb02a573c58f4dc67c64681b">$QUERY_STRING</a>;           <span class="comment">// keeps the ($_GET) Querystring of the original Request</span>
<a name="l00279"></a><a class="code" href="classhn__captcha.html#31011448f055ef21e72e39071bbff167">00279</a> <span class="comment"></span>   var <a class="code" href="classhn__captcha.html#31011448f055ef21e72e39071bbff167">$current_try</a> = 0;
<a name="l00281"></a><a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">00281</a>    var <a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">$r</a>;
<a name="l00283"></a><a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">00283</a>    var <a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">$g</a>;
<a name="l00285"></a><a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">00285</a>    var <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 
<a name="l00289"></a>00289    <span class="comment">//</span>
<a name="l00290"></a>00290    <span class="comment">//   CONSTRUCTOR</span>
<a name="l00291"></a>00291    <span class="comment">//</span>
<a name="l00292"></a>00292 
<a name="l00300"></a><a class="code" href="classhn__captcha.html#47496a3e7f2d9b2f245191af0aaf6da4">00300</a>    function <a class="code" href="classhn__captcha.html#47496a3e7f2d9b2f245191af0aaf6da4">hn_captcha</a>($config,$secure=TRUE)
<a name="l00301"></a>00301    {
<a name="l00302"></a>00302 
<a name="l00303"></a>00303       <span class="comment">// Test for GD-Library(-Version)</span>
<a name="l00304"></a>00304       $this-&gt;gd_version = $this-&gt;get_gd_version();
<a name="l00305"></a>00305       <span class="keywordflow">if</span>($this-&gt;gd_version == 0) die(<span class="stringliteral">"There is no GD-Library-Support enabled. The Captcha-Class cannot be used!"</span>);
<a name="l00306"></a>00306       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: The available GD-Library has major version "</span>.$this-&gt;gd_version;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 
<a name="l00309"></a>00309       <span class="comment">// Hackprevention</span>
<a name="l00310"></a>00310       <span class="keywordflow">if</span>(
<a name="l00311"></a>00311       (isset(<a class="code" href="admin_2index_8php.html#adfe36d0024c98a104c6592111fa6669">$_GET</a>['maxtry']) || isset($_POST['maxtry']) || isset($_COOKIE['maxtry']))
<a name="l00312"></a>00312       ||
<a name="l00313"></a>00313       (isset(<a class="code" href="admin_2index_8php.html#adfe36d0024c98a104c6592111fa6669">$_GET</a>['debug']) || isset($_POST['debug']) || isset($_COOKIE['debug']))
<a name="l00314"></a>00314       ||
<a name="l00315"></a>00315       (isset(<a class="code" href="admin_2index_8php.html#adfe36d0024c98a104c6592111fa6669">$_GET</a>['captcharefresh']) || isset($_COOKIE['captcharefresh']))
<a name="l00316"></a>00316       ||
<a name="l00317"></a>00317       (isset($_POST['captcharefresh']) &amp;&amp; isset($_POST['private_key']))
<a name="l00318"></a>00318       )
<a name="l00319"></a>00319       {
<a name="l00320"></a>00320          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Buuh. You are a bad guy!"</span>;
<a name="l00321"></a>00321          <span class="keywordflow">if</span>(isset($this-&gt;badguys_url) &amp;&amp; !headers_sent()) header('location: '.$this-&gt;badguys_url);
<a name="l00322"></a>00322          <span class="keywordflow">else</span> die('Sorry.');
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 
<a name="l00326"></a>00326       <span class="comment">// extracts config array</span>
<a name="l00327"></a>00327       <span class="keywordflow">if</span>(is_array($config))
<a name="l00328"></a>00328       {
<a name="l00329"></a>00329          <span class="keywordflow">if</span>($secure &amp;&amp; strcmp('4.2.0', phpversion()) &lt; 0)
<a name="l00330"></a>00330          {
<a name="l00331"></a>00331             <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Extracts Config-Array in secure-mode!"</span>;
<a name="l00332"></a>00332             $valid = get_class_vars(get_class($this));
<a name="l00333"></a>00333             <span class="keywordflow">foreach</span>($config as $k=&gt;$v)
<a name="l00334"></a>00334             {
<a name="l00335"></a>00335                <span class="keywordflow">if</span>(array_key_exists($k,$valid)) $this-&gt;$k = $v;
<a name="l00336"></a>00336             }
<a name="l00337"></a>00337          }
<a name="l00338"></a>00338          <span class="keywordflow">else</span>
<a name="l00339"></a>00339          {
<a name="l00340"></a>00340             <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Extracts Config-Array in unsecure-mode!"</span>;
<a name="l00341"></a>00341             <span class="keywordflow">foreach</span>($config as $k=&gt;$v) $this-&gt;$k = $v;
<a name="l00342"></a>00342          }
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 
<a name="l00346"></a>00346       <span class="comment">// check vars for maxtry, secretposition and min-max-size</span>
<a name="l00347"></a>00347       $this-&gt;maxtry = ($this-&gt;maxtry &gt; 9 || $this-&gt;maxtry &lt; 1) ? 3 : $this-&gt;maxtry;
<a name="l00348"></a>00348       $this-&gt;secretposition = ($this-&gt;secretposition &gt; 32 || $this-&gt;secretposition &lt; 1) ? $this-&gt;maxtry : $this-&gt;secretposition;
<a name="l00349"></a>00349       <span class="keywordflow">if</span>($this-&gt;minsize &gt; $this-&gt;maxsize)
<a name="l00350"></a>00350       {
<a name="l00351"></a>00351          $temp = $this-&gt;minsize;
<a name="l00352"></a>00352          $this-&gt;minsize = $this-&gt;maxsize;
<a name="l00353"></a>00353          $this-&gt;maxsize = $temp;
<a name="l00354"></a>00354          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"&lt;br&gt;-Captcha-Debug: Arrghh! What do you think I mean with min and max? Switch minsize with maxsize."</span>;
<a name="l00355"></a>00355       }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 
<a name="l00358"></a>00358       <span class="comment">// check TrueTypeFonts</span>
<a name="l00359"></a>00359       <span class="keywordflow">if</span>(is_array($this-&gt;TTF_RANGE))
<a name="l00360"></a>00360       {
<a name="l00361"></a>00361          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Check given TrueType-Array! ("</span>.count($this-&gt;TTF_RANGE).<span class="stringliteral">")"</span>;
<a name="l00362"></a>00362          $temp = array();
<a name="l00363"></a>00363          <span class="keywordflow">foreach</span>($this-&gt;TTF_RANGE as $k=&gt;$v)
<a name="l00364"></a>00364          {
<a name="l00365"></a>00365             <span class="keywordflow">if</span>(is_readable($this-&gt;TTF_folder.$v)) $temp[] = $v;
<a name="l00366"></a>00366          }
<a name="l00367"></a>00367          $this-&gt;TTF_RANGE = $temp;
<a name="l00368"></a>00368          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Valid TrueType-files: ("</span>.count($this-&gt;TTF_RANGE).<span class="stringliteral">")"</span>;
<a name="l00369"></a>00369          <span class="keywordflow">if</span>(count($this-&gt;TTF_RANGE) &lt; 1) die('No Truetypefont available <span class="keywordflow">for</span> the CaptchaClass.');
<a name="l00370"></a>00370       }
<a name="l00371"></a>00371       <span class="keywordflow">else</span>
<a name="l00372"></a>00372       {
<a name="l00373"></a>00373          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Check given TrueType-File! ("</span>.$this-&gt;TTF_RANGE.<span class="stringliteral">")"</span>;
<a name="l00374"></a>00374          <span class="keywordflow">if</span>(!is_readable($this-&gt;TTF_folder.$this-&gt;TTF_RANGE)) die('No Truetypefont available <span class="keywordflow">for</span> the CaptchaClass.');
<a name="l00375"></a>00375       }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377       <span class="comment">// select first TrueTypeFont</span>
<a name="l00378"></a>00378       $this-&gt;change_TTF();
<a name="l00379"></a>00379       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Set current TrueType-File: ("</span>.$this-&gt;TTF_file.<span class="stringliteral">")"</span>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a>00382       <span class="comment">// get number of noise-chars for background if is enabled</span>
<a name="l00383"></a>00383       $this-&gt;nb_noise = $this-&gt;noise ? ($this-&gt;chars * $this-&gt;noisefactor) : 0;
<a name="l00384"></a>00384       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Set number of noise characters to: ("</span>.$this-&gt;nb_noise.<span class="stringliteral">")"</span>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       <span class="comment">// set dimension of image</span>
<a name="l00388"></a>00388       $this-&gt;lx = ($this-&gt;chars + 1) * (<span class="keywordtype">int</span>)(($this-&gt;maxsize + $this-&gt;minsize) / 1.5);
<a name="l00389"></a>00389       $this-&gt;ly = (int)(2.4 * $this-&gt;maxsize);
<a name="l00390"></a>00390       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Set image dimension to: ("</span>.$this-&gt;lx.<span class="stringliteral">" x "</span>.$this-&gt;ly.<span class="stringliteral">")"</span>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 
<a name="l00393"></a>00393       <span class="comment">// set all messages</span>
<a name="l00394"></a>00394       <span class="comment">// (if you add a new language, you also want to add a line to the function "notvalid_msg()" at the end of the class!)</span>
<a name="l00395"></a>00395       $this-&gt;messages = array(
<a name="l00396"></a>00396                                 'de'=&gt;array(
<a name="l00397"></a>00397                                                         'msg1'=&gt;'Du mu�t die &lt;b&gt;'.$this-&gt;chars.' Zeichen&lt;/b&gt; im Bild, (Zahlen&amp;nbsp;von&amp;nbsp;&lt;b&gt;0&amp;nbsp;-&amp;nbsp;9&lt;/b&gt; und Buchstaben&amp;nbsp;von&amp;nbsp;&lt;b&gt;A&amp;nbsp;-&amp;nbsp;F&lt;/b&gt;),&lt;br&gt;in das Feld eintragen und das Formular abschicken um den Download zu starten.',
<a name="l00398"></a>00398                                                         'msg2'=&gt;'Ohje, das kann ich nicht lesen. Bitte, generiere mir eine ',
<a name="l00399"></a>00399                                                         'buttontext'=&gt;'abschicken',
<a name="l00400"></a>00400                                                         'refreshbuttontext'=&gt;'neue ID'
<a name="l00401"></a>00401                                                         ),
<a name="l00402"></a>00402                                 'en'=&gt;array(
<a name="l00403"></a>00403                                                         'msg1'=&gt;'You must read and type the &lt;b&gt;'.$this-&gt;chars.' chars&lt;/b&gt; within &lt;b&gt;0..9&lt;/b&gt; and &lt;b&gt;A..F&lt;/b&gt;, and submit the form.',
<a name="l00404"></a>00404                                                         'msg2'=&gt;'Oh no, I cannot read <span class="keyword">this</span>. Please, generate a ',
<a name="l00405"></a>00405                                                         'buttontext'=&gt;'submit',
<a name="l00406"></a>00406                                                         'refreshbuttontext'=&gt;'<span class="keyword">new</span> ID'
<a name="l00407"></a>00407                                                         )
<a name="l00408"></a>00408                                                         );
<a name="l00409"></a>00409                                                         $this-&gt;msg1 = $this-&gt;messages[$this-&gt;lang]['msg1'];
<a name="l00410"></a>00410                                                         $this-&gt;msg2 = $this-&gt;messages[$this-&gt;lang]['msg2'];
<a name="l00411"></a>00411                                                         $this-&gt;buttontext = $this-&gt;messages[$this-&gt;lang]['buttontext'];
<a name="l00412"></a>00412                                                         $this-&gt;refreshbuttontext = $this-&gt;messages[$this-&gt;lang]['refreshbuttontext'];
<a name="l00413"></a>00413                                                         <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Set messages to language: ("</span>.$this-&gt;lang.<span class="stringliteral">")"</span>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                                                         <span class="comment">// keep params from original GET-request</span>
<a name="l00417"></a>00417                                                         <span class="comment">// (if you use POST or COOKIES, you have to implement it yourself, sorry.)</span>
<a name="l00418"></a>00418                                                         $this-&gt;QUERY_STRING = strlen(trim($_SERVER['QUERY_STRING'])) &gt; 0 ? <span class="charliteral">'?'</span>.strip_tags($_SERVER['QUERY_STRING']) : '';
<a name="l00419"></a>00419                                                         $refresh = $_SERVER['PHP_SELF'].$this-&gt;QUERY_STRING;
<a name="l00420"></a>00420                                                         <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Keep this params from original GET-request: ("</span>.$this-&gt;QUERY_STRING.<span class="stringliteral">")"</span>;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 
<a name="l00423"></a>00423                                                         <span class="comment">// check Postvars</span>
<a name="l00424"></a>00424                                                         <span class="keywordflow">if</span>(isset($_POST['public_key']))  $this-&gt;public_K = substr(strip_tags($_POST['public_key']),0,$this-&gt;chars);
<a name="l00425"></a>00425                                                         <span class="keywordflow">if</span>(isset($_POST['private_key'])) $this-&gt;private_K = substr(strip_tags($_POST['private_key']),0,$this-&gt;chars);
<a name="l00426"></a>00426                                                         $this-&gt;current_try = isset($_POST['hncaptcha']) ? $this-&gt;get_try() : 0;
<a name="l00427"></a>00427                                                         <span class="keywordflow">if</span>(!isset($_POST['captcharefresh'])) $this-&gt;current_try++;
<a name="l00428"></a>00428                                                         <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Check POST-vars, current try is: ("</span>.$this-&gt;current_try.<span class="stringliteral">")"</span>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431                                                         <span class="comment">// generate Keys</span>
<a name="l00432"></a>00432                                                         $this-&gt;key = md5($this-&gt;secretstring);
<a name="l00433"></a>00433                                                         $this-&gt;public_key = substr(md5(uniqid(rand(),<span class="keyword">true</span>)), 0, $this-&gt;chars);
<a name="l00434"></a>00434                                                         <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Generate Keys, public key is: ("</span>.$this-&gt;public_key.<span class="stringliteral">")"</span>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00441"></a>00441    <span class="comment">//</span>
<a name="l00442"></a>00442    <span class="comment">//   PUBLIC METHODS</span>
<a name="l00443"></a>00443    <span class="comment">//</span>
<a name="l00444"></a>00444 
<a name="l00453"></a><a class="code" href="classhn__captcha.html#4fe7655f9890c7271b4d85a0ef7849b6">00453</a>    function <a class="code" href="classhn__captcha.html#4fe7655f9890c7271b4d85a0ef7849b6">display_form</a>()
<a name="l00454"></a>00454    {
<a name="l00455"></a>00455       $try = $this-&gt;get_try(FALSE);
<a name="l00456"></a>00456       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Generate a string which contains current try: ($try)"</span>;
<a name="l00457"></a>00457       $s  = '&lt;div <span class="keywordtype">id</span>=<span class="stringliteral">"captcha"</span>&gt;';
<a name="l00458"></a>00458       $s .= '&lt;form <span class="keyword">class</span>=<span class="stringliteral">"captcha"</span> name=<span class="stringliteral">"captcha1"</span> action=<span class="stringliteral">"'.$_SERVER['PHP_SELF'].$this-&gt;QUERY_STRING.'"</span> method=<span class="stringliteral">"POST"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00459"></a>00459       $s .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"hncaptcha"</span> value=<span class="stringliteral">"'.$try.'"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00460"></a>00460       $s .= '&lt;p <span class="keyword">class</span>=<span class="stringliteral">"captcha_notvalid"</span>&gt;'.$this-&gt;notvalid_msg().'&lt;/p&gt;';
<a name="l00461"></a>00461       $s .= '&lt;p <span class="keyword">class</span>=<span class="stringliteral">"captcha_1"</span>&gt;'.$this-&gt;display_captcha().<span class="stringliteral">"&lt;/p&gt;\n"</span>;
<a name="l00462"></a>00462       $s .= '&lt;p <span class="keyword">class</span>=<span class="stringliteral">"captcha_1"</span>&gt;'.$this-&gt;msg1.'&lt;/p&gt;';
<a name="l00463"></a>00463       $s .= '&lt;p <span class="keyword">class</span>=<span class="stringliteral">"captcha_1"</span>&gt;&lt;input <span class="keyword">class</span>=<span class="stringliteral">"captcha"</span> type=<span class="stringliteral">"text"</span> name=<span class="stringliteral">"private_key"</span> value=<span class="stringliteral">""</span> maxlength=<span class="stringliteral">"'.$this-&gt;chars.'"</span> size=<span class="stringliteral">"'.$this-&gt;chars.'"</span>&gt;&amp;nbsp;&amp;nbsp;';
<a name="l00464"></a>00464       $s .= '&lt;input <span class="keyword">class</span>=<span class="stringliteral">"captcha"</span> type=<span class="stringliteral">"submit"</span> value=<span class="stringliteral">"'.$this-&gt;buttontext.'"</span>&gt;'.<span class="stringliteral">"&lt;/p&gt;\n"</span>;
<a name="l00465"></a>00465       $s .= '&lt;/form&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00466"></a>00466       <span class="keywordflow">if</span>($this-&gt;refreshlink)
<a name="l00467"></a>00467       {
<a name="l00468"></a>00468          $s .= '&lt;form style=<span class="stringliteral">"display:inline;"</span> name=<span class="stringliteral">"captcha2"</span> action=<span class="stringliteral">"'.$_SERVER['PHP_SELF'].$this-&gt;QUERY_STRING.'"</span> method=<span class="stringliteral">"POST"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00469"></a>00469          $s .= '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"captcharefresh"</span> value=<span class="stringliteral">"1"</span>&gt;&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"hncaptcha"</span> value=<span class="stringliteral">"'.$try.'"</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00470"></a>00470          $s .= '&lt;p <span class="keyword">class</span>=<span class="stringliteral">"captcha_2"</span>&gt;'.$this-&gt;msg2;
<a name="l00471"></a>00471          $s .= $this-&gt;<a class="code" href="classhn__captcha.html#169442c5d37041dde147a1e77c0ae490">public_key_input</a>().'&lt;input <span class="keyword">class</span>=<span class="stringliteral">"captcha"</span> type=<span class="stringliteral">"submit"</span> value=<span class="stringliteral">"'.$this-&gt;refreshbuttontext.'"</span>&gt;'.<span class="stringliteral">"&lt;/p&gt;\n"</span>;
<a name="l00472"></a>00472          $s .= '&lt;/form&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474       $s .= '&lt;/div&gt;';
<a name="l00475"></a>00475       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Output Form with captcha-image.&lt;br&gt;&lt;br&gt;"</span>;
<a name="l00476"></a>00476       <span class="keywordflow">return</span> $s;
<a name="l00477"></a>00477    }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00488"></a><a class="code" href="classhn__captcha.html#58cf521777ae952c7e3c1f21850f44cf">00488</a>    function <a class="code" href="classhn__captcha.html#58cf521777ae952c7e3c1f21850f44cf">validate_submit</a>()
<a name="l00489"></a>00489    {
<a name="l00490"></a>00490       <span class="keywordflow">if</span>($this-&gt;check_captcha($this-&gt;public_K,$this-&gt;private_K))
<a name="l00491"></a>00491       {
<a name="l00492"></a>00492          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Validating submitted form returns: (1)"</span>;
<a name="l00493"></a>00493          <span class="keywordflow">return</span> 1;
<a name="l00494"></a>00494       }
<a name="l00495"></a>00495       <span class="keywordflow">else</span>
<a name="l00496"></a>00496       {
<a name="l00497"></a>00497          <span class="keywordflow">if</span>($this-&gt;current_try &gt; $this-&gt;maxtry)
<a name="l00498"></a>00498          {
<a name="l00499"></a>00499             <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Validating submitted form returns: (3)"</span>;
<a name="l00500"></a>00500             <span class="keywordflow">return</span> 3;
<a name="l00501"></a>00501          }
<a name="l00502"></a>00502          elseif($this-&gt;current_try &gt; 0)
<a name="l00503"></a>00503          {
<a name="l00504"></a>00504             <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Validating submitted form returns: (2)"</span>;
<a name="l00505"></a>00505             <span class="keywordflow">return</span> 2;
<a name="l00506"></a>00506          }
<a name="l00507"></a>00507          <span class="keywordflow">else</span>
<a name="l00508"></a>00508          {
<a name="l00509"></a>00509             <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Validating submitted form returns: (0)"</span>;
<a name="l00510"></a>00510             <span class="keywordflow">return</span> 0;
<a name="l00511"></a>00511          }
<a name="l00512"></a>00512       }
<a name="l00513"></a>00513    }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 
<a name="l00518"></a>00518    <span class="comment">//</span>
<a name="l00519"></a>00519    <span class="comment">//   PRIVATE METHODS</span>
<a name="l00520"></a>00520    <span class="comment">//</span>
<a name="l00521"></a>00521 
<a name="l00523"></a><a class="code" href="classhn__captcha.html#af028dae3e80e1ab7e42a96092c9c26a">00523</a>    function <a class="code" href="classhn__captcha.html#af028dae3e80e1ab7e42a96092c9c26a">display_captcha</a>($onlyTheImage=FALSE){
<a name="l00524"></a>00524       $this-&gt;<a class="code" href="classhn__captcha.html#ff57a917a92eac5833273c5034ad37c6">make_captcha</a>();
<a name="l00525"></a>00525       $is = getimagesize($this-&gt;get_filename());
<a name="l00526"></a>00526       <span class="keywordflow">if</span>($onlyTheImage) <span class="keywordflow">return</span> <span class="stringliteral">"\n"</span>.'&lt;img <span class="keyword">class</span>=<span class="stringliteral">"captchapict"</span> src=<span class="stringliteral">"'.$this-&gt;get_filename_url().'"</span> '.$is[3].' alt=<span class="stringliteral">"This is a captcha-picture. It is used to prevent mass-access by robots. (see: www.captcha.net)"</span> title=<span class="stringliteral">""</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00527"></a>00527       <span class="keywordflow">else</span> <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classhn__captcha.html#169442c5d37041dde147a1e77c0ae490">public_key_input</a>().<span class="stringliteral">"\n"</span>.'&lt;img <span class="keyword">class</span>=<span class="stringliteral">"captchapict"</span> src=<span class="stringliteral">"'.$this-&gt;get_filename_url().'"</span> '.$is[3].' alt=<span class="stringliteral">"This is a captcha-picture. It is used to prevent mass-access by robots. (see: www.captcha.net)"</span> title=<span class="stringliteral">""</span>&gt;'.<span class="stringliteral">"\n"</span>;
<a name="l00528"></a>00528    }
<a name="l00529"></a>00529     
<a name="l00534"></a><a class="code" href="classhn__captcha.html#0207a5b7002ef6b5aa73ec7659802179">00534</a>    function <a class="code" href="classhn__captcha.html#0207a5b7002ef6b5aa73ec7659802179">flush_captcha_image</a>(){
<a name="l00535"></a>00535       $image_path = $this-&gt;get_filename();
<a name="l00536"></a>00536 
<a name="l00537"></a>00537       <span class="keywordflow">if</span> (!file_exists($image_path)){
<a name="l00538"></a>00538          $this-&gt;<a class="code" href="classhn__captcha.html#ff57a917a92eac5833273c5034ad37c6">make_captcha</a>();
<a name="l00539"></a>00539       }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541       header(<span class="stringliteral">"Content-Type: image/jpeg"</span>);
<a name="l00542"></a>00542       $im = @imagecreatefromjpeg($this-&gt;get_filename());
<a name="l00543"></a>00543       imagejpeg($im);
<a name="l00544"></a>00544       imagedestroy($im);
<a name="l00545"></a>00545       die();
<a name="l00546"></a>00546 
<a name="l00547"></a>00547    }
<a name="l00548"></a>00548 
<a name="l00550"></a><a class="code" href="classhn__captcha.html#169442c5d37041dde147a1e77c0ae490">00550</a>    function <a class="code" href="classhn__captcha.html#169442c5d37041dde147a1e77c0ae490">public_key_input</a>()
<a name="l00551"></a>00551    {
<a name="l00552"></a>00552       <span class="keywordflow">return</span> '&lt;input type=<span class="stringliteral">"hidden"</span> name=<span class="stringliteral">"public_key"</span> value=<span class="stringliteral">"'.$this-&gt;public_key.'"</span>&gt;';
<a name="l00553"></a>00553    }
<a name="l00554"></a>00554 
<a name="l00556"></a><a class="code" href="classhn__captcha.html#ff57a917a92eac5833273c5034ad37c6">00556</a>    function <a class="code" href="classhn__captcha.html#ff57a917a92eac5833273c5034ad37c6">make_captcha</a>()
<a name="l00557"></a>00557    {
<a name="l00558"></a>00558       $private_key = $this-&gt;generate_private();
<a name="l00559"></a>00559       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Generate private key: ($private_key)"</span>;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="comment">// create Image and set the apropriate function depending on GD-Version &amp; websafecolor-value</span>
<a name="l00562"></a>00562       <span class="keywordflow">if</span>($this-&gt;gd_version &gt;= 2 &amp;&amp; !$this-&gt;websafecolors)
<a name="l00563"></a>00563       {
<a name="l00564"></a>00564          $func1 = 'imagecreatetruecolor';
<a name="l00565"></a>00565          $func2 = 'imagecolorallocate';
<a name="l00566"></a>00566       }
<a name="l00567"></a>00567       <span class="keywordflow">else</span>
<a name="l00568"></a>00568       {
<a name="l00569"></a>00569          $func1 = 'imageCreate';
<a name="l00570"></a>00570          $func2 = 'imagecolorclosest';
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572       $image = $func1($this-&gt;lx,$this-&gt;ly);
<a name="l00573"></a>00573       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Generate ImageStream with: ($func1())"</span>;
<a name="l00574"></a>00574       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: For colordefinitions we use: ($func2())"</span>;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="comment">// Set Backgroundcolor</span>
<a name="l00578"></a>00578       $this-&gt;random_color(224, 255);
<a name="l00579"></a>00579       $back =  @imagecolorallocate($image, $this-&gt;r, $this-&gt;g, $this-&gt;b);
<a name="l00580"></a>00580       @ImageFilledRectangle($image,0,0,$this-&gt;lx,$this-&gt;ly,$back);
<a name="l00581"></a>00581       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: We allocate one color for Background: ("</span>.$this-&gt;r.<span class="stringliteral">"-"</span>.$this-&gt;g.<span class="stringliteral">"-"</span>.$this-&gt;b.<span class="stringliteral">")"</span>;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583       <span class="comment">// allocates the 216 websafe color palette to the image</span>
<a name="l00584"></a>00584       <span class="keywordflow">if</span>($this-&gt;gd_version &lt; 2 || $this-&gt;websafecolors) $this-&gt;makeWebsafeColors($image);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 
<a name="l00587"></a>00587       <span class="comment">// fill with noise or grid</span>
<a name="l00588"></a>00588       <span class="keywordflow">if</span>($this-&gt;nb_noise &gt; 0)
<a name="l00589"></a>00589       {
<a name="l00590"></a>00590          <span class="comment">// random characters in background with random position, angle, color</span>
<a name="l00591"></a>00591          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Fill background with noise: ("</span>.$this-&gt;nb_noise.<span class="stringliteral">")"</span>;
<a name="l00592"></a>00592          <span class="keywordflow">for</span>($i=0; $i &lt; $this-&gt;nb_noise; $i++)
<a name="l00593"></a>00593          {
<a name="l00594"></a>00594             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00595"></a>00595             $size       = intval(rand((<span class="keywordtype">int</span>)($this-&gt;minsize / 2.3), (<span class="keywordtype">int</span>)($this-&gt;maxsize / 1.7)));
<a name="l00596"></a>00596             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00597"></a>00597             $angle      = intval(rand(0, 360));
<a name="l00598"></a>00598             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00599"></a>00599             $x          = intval(rand(0, $this-&gt;lx));
<a name="l00600"></a>00600             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00601"></a>00601             $y          = intval(rand(0, (<span class="keywordtype">int</span>)($this-&gt;ly - ($size / 5))));
<a name="l00602"></a>00602             $this-&gt;random_color(160, 224);
<a name="l00603"></a>00603             $color      = $func2($image, $this-&gt;r, $this-&gt;g, $this-&gt;b);
<a name="l00604"></a>00604             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00605"></a>00605             $text       = chr(intval(rand(45,250)));
<a name="l00606"></a>00606             @ImageTTFText($image, $size, $angle, $x, $y, $color, $this-&gt;change_TTF(), $text);
<a name="l00607"></a>00607          }
<a name="l00608"></a>00608       }
<a name="l00609"></a>00609       <span class="keywordflow">else</span>
<a name="l00610"></a>00610       {
<a name="l00611"></a>00611          <span class="comment">// generate grid</span>
<a name="l00612"></a>00612          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Fill background with x-gridlines: ("</span>.(int)($this-&gt;lx / (<span class="keywordtype">int</span>)($this-&gt;minsize / 1.5)).<span class="stringliteral">")"</span>;
<a name="l00613"></a>00613          <span class="keywordflow">for</span>($i=0; $i &lt; $this-&gt;lx; $i += (int)($this-&gt;minsize / 1.5))
<a name="l00614"></a>00614          {
<a name="l00615"></a>00615             $this-&gt;random_color(160, 224);
<a name="l00616"></a>00616             $color      = $func2($image, $this-&gt;r, $this-&gt;g, $this-&gt;b);
<a name="l00617"></a>00617             @imageline($image, $i, 0, $i, $this-&gt;ly, $color);
<a name="l00618"></a>00618          }
<a name="l00619"></a>00619          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Fill background with y-gridlines: ("</span>.(int)($this-&gt;ly / (<span class="keywordtype">int</span>)(($this-&gt;minsize / 1.8))).<span class="stringliteral">")"</span>;
<a name="l00620"></a>00620          <span class="keywordflow">for</span>($i=0 ; $i &lt; $this-&gt;ly; $i += (int)($this-&gt;minsize / 1.8))
<a name="l00621"></a>00621          {
<a name="l00622"></a>00622             $this-&gt;random_color(160, 224);
<a name="l00623"></a>00623             $color      = $func2($image, $this-&gt;r, $this-&gt;g, $this-&gt;b);
<a name="l00624"></a>00624             @imageline($image, 0, $i, $this-&gt;lx, $i, $color);
<a name="l00625"></a>00625          }
<a name="l00626"></a>00626       }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628       <span class="comment">// generate Text</span>
<a name="l00629"></a>00629       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Fill forground with chars and shadows: ("</span>.$this-&gt;chars.<span class="stringliteral">")"</span>;
<a name="l00630"></a>00630       <span class="keywordflow">for</span>($i=0, $x = intval(rand($this-&gt;minsize,$this-&gt;maxsize)); $i &lt; $this-&gt;chars; $i++)
<a name="l00631"></a>00631       {
<a name="l00632"></a>00632          $text  = strtoupper(substr($private_key, $i, 1));
<a name="l00633"></a>00633          srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00634"></a>00634          $angle = intval(rand(($this-&gt;maxrotation * -1), $this-&gt;maxrotation));
<a name="l00635"></a>00635          srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00636"></a>00636          $size  = intval(rand($this-&gt;minsize, $this-&gt;maxsize));
<a name="l00637"></a>00637          srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00638"></a>00638          $y             = intval(rand((<span class="keywordtype">int</span>)($size * 1.5), (<span class="keywordtype">int</span>)($this-&gt;ly - ($size / 7))));
<a name="l00639"></a>00639          $this-&gt;random_color(0, 127);
<a name="l00640"></a>00640          $color =  $func2($image, $this-&gt;r, $this-&gt;g, $this-&gt;b);
<a name="l00641"></a>00641          $this-&gt;random_color(0, 127);
<a name="l00642"></a>00642          $shadow = $func2($image, $this-&gt;r + 127, $this-&gt;g + 127, $this-&gt;b + 127);
<a name="l00643"></a>00643          @ImageTTFText($image, $size, $angle, $x + (<span class="keywordtype">int</span>)($size / 15), $y, $shadow, $this-&gt;change_TTF(), $text);
<a name="l00644"></a>00644          @ImageTTFText($image, $size, $angle, $x, $y - (<span class="keywordtype">int</span>)($size / 15), $color, $this-&gt;TTF_file, $text);
<a name="l00645"></a>00645          $x += (int)($size + ($this-&gt;minsize / 5));
<a name="l00646"></a>00646       }
<a name="l00647"></a>00647       @ImageJPEG($image, $this-&gt;get_filename(), $this-&gt;jpegquality);
<a name="l00648"></a>00648       $res = file_exists($this-&gt;get_filename());
<a name="l00649"></a>00649       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Safe Image with quality ["</span>.$this-&gt;jpegquality.<span class="stringliteral">"] as ("</span>.$this-&gt;get_filename().<span class="stringliteral">") returns: ("</span>.($res ? 'TRUE' : 'FALSE').<span class="stringliteral">")"</span>;
<a name="l00650"></a>00650       @ImageDestroy($image);
<a name="l00651"></a>00651       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Destroy Imagestream."</span>;
<a name="l00652"></a>00652       <span class="keywordflow">if</span>(!$res) die('Unable to safe captcha-image.');
<a name="l00653"></a>00653    }
<a name="l00654"></a>00654 
<a name="l00656"></a>00656    function makeWebsafeColors(&amp;$image)
<a name="l00657"></a>00657    {
<a name="l00658"></a>00658       <span class="comment">//$a = array();</span>
<a name="l00659"></a>00659       <span class="keywordflow">for</span>(<a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">$r</a> = 0; <a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">$r</a> &lt;= 255; <a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">$r</a> += 51)
<a name="l00660"></a>00660       {
<a name="l00661"></a>00661          <span class="keywordflow">for</span>(<a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">$g</a> = 0; <a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">$g</a> &lt;= 255; <a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">$g</a> += 51)
<a name="l00662"></a>00662          {
<a name="l00663"></a>00663             <span class="keywordflow">for</span>(<a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a> = 0; <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a> &lt;= 255; <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a> += 51)
<a name="l00664"></a>00664             {
<a name="l00665"></a>00665                $color = imagecolorallocate($image, <a class="code" href="classhn__captcha.html#d1088d654d6c80122caf4ce9f842d3ab">$r</a>, <a class="code" href="classhn__captcha.html#c81f08fddc782c0b96e33edbc9b46672">$g</a>, <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a>);
<a name="l00666"></a>00666                <span class="comment">//$a[$color] = array('r'=&gt;$r,'g'=&gt;$g,'b'=&gt;$b);</span>
<a name="l00667"></a>00667             }
<a name="l00668"></a>00668          }
<a name="l00669"></a>00669       }
<a name="l00670"></a>00670       <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Allocate 216 websafe colors to image: ("</span>.imagecolorstotal($image).<span class="stringliteral">")"</span>;
<a name="l00671"></a>00671       <span class="comment">//return $a;</span>
<a name="l00672"></a>00672    }
<a name="l00673"></a>00673 
<a name="l00675"></a>00675    function random_color($min,$max)
<a name="l00676"></a>00676    {
<a name="l00677"></a>00677       srand((<span class="keywordtype">double</span>)microtime() * 1000000);
<a name="l00678"></a>00678       $this-&gt;r = intval(rand($min,$max));
<a name="l00679"></a>00679       srand((<span class="keywordtype">double</span>)microtime() * 1000000);
<a name="l00680"></a>00680       $this-&gt;g = intval(rand($min,$max));
<a name="l00681"></a>00681       srand((<span class="keywordtype">double</span>)microtime() * 1000000);
<a name="l00682"></a>00682       $this-&gt;b = intval(rand($min,$max));
<a name="l00683"></a>00683       <span class="comment">//echo " (".$this-&gt;r."-".$this-&gt;g."-".$this-&gt;b.") ";</span>
<a name="l00684"></a>00684    }
<a name="l00685"></a>00685 
<a name="l00687"></a>00687    function change_TTF()
<a name="l00688"></a>00688    {
<a name="l00689"></a>00689       <span class="keywordflow">if</span>(is_array($this-&gt;TTF_RANGE))
<a name="l00690"></a>00690       {
<a name="l00691"></a>00691          srand((<span class="keywordtype">float</span>)microtime() * 10000000);
<a name="l00692"></a>00692          <a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">$key</a> = array_rand($this-&gt;TTF_RANGE);
<a name="l00693"></a>00693          $this-&gt;TTF_file = $this-&gt;TTF_folder.$this-&gt;TTF_RANGE[<a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">$key</a>];
<a name="l00694"></a>00694       }
<a name="l00695"></a>00695       <span class="keywordflow">else</span>
<a name="l00696"></a>00696       {
<a name="l00697"></a>00697          $this-&gt;TTF_file = $this-&gt;TTF_folder.$this-&gt;TTF_RANGE;
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699       <span class="keywordflow">return</span> $this-&gt;TTF_file;
<a name="l00700"></a>00700    }
<a name="l00701"></a>00701 
<a name="l00703"></a>00703    function check_captcha($public,$private)
<a name="l00704"></a>00704    {
<a name="l00705"></a>00705       $res = 'FALSE';
<a name="l00706"></a>00706       <span class="comment">// when check, destroy picture on disk</span>
<a name="l00707"></a>00707       <span class="keywordflow">if</span>(file_exists($this-&gt;get_filename($public)))
<a name="l00708"></a>00708       {
<a name="l00709"></a>00709          $res = @unlink($this-&gt;get_filename($public)) ? 'TRUE' : 'FALSE';
<a name="l00710"></a>00710          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Delete image ("</span>.$this-&gt;get_filename($public).<span class="stringliteral">") returns: ($res)"</span>;
<a name="l00711"></a>00711          $res = (strtolower($private)==strtolower($this-&gt;generate_private($public))) ? 'TRUE' : 'FALSE';
<a name="l00712"></a>00712          <span class="keywordflow">if</span>($this-&gt;debug) echo <span class="stringliteral">"\n&lt;br&gt;-Captcha-Debug: Comparing public with private key returns: ($res)"</span>;
<a name="l00713"></a>00713       }
<a name="l00714"></a>00714       <span class="keywordflow">return</span> $res == 'TRUE' ? TRUE : FALSE;
<a name="l00715"></a>00715    }
<a name="l00716"></a>00716    <span class="comment">/* OLD FUNCTION, without HotFix from Daniel Jagszent :</span>
<a name="l00717"></a>00717 <span class="comment">    function check_captcha($public,$private)</span>
<a name="l00718"></a>00718 <span class="comment">    {</span>
<a name="l00719"></a>00719 <span class="comment">    // when check, destroy picture on disk</span>
<a name="l00720"></a>00720 <span class="comment">    if(file_exists($this-&gt;get_filename($public)))</span>
<a name="l00721"></a>00721 <span class="comment">    {</span>
<a name="l00722"></a>00722 <span class="comment">    $res = @unlink($this-&gt;get_filename($public)) ? 'TRUE' : 'FALSE';</span>
<a name="l00723"></a>00723 <span class="comment">    if($this-&gt;debug) echo "\n&lt;br&gt;-Captcha-Debug: Delete image (".$this-&gt;get_filename($public).") returns: ($res)";</span>
<a name="l00724"></a>00724 <span class="comment">    }</span>
<a name="l00725"></a>00725 <span class="comment">    $res = (strtolower($private)==strtolower($this-&gt;generate_private($public))) ? 'TRUE' : 'FALSE';</span>
<a name="l00726"></a>00726 <span class="comment">    if($this-&gt;debug) echo "\n&lt;br&gt;-Captcha-Debug: Comparing public with private key returns: ($res)";</span>
<a name="l00727"></a>00727 <span class="comment">    return $res == 'TRUE' ? TRUE : FALSE;</span>
<a name="l00728"></a>00728 <span class="comment">    }</span>
<a name="l00729"></a>00729 <span class="comment">    */</span>
<a name="l00730"></a>00730 
<a name="l00732"></a>00732    function get_filename($public=<span class="stringliteral">""</span>)
<a name="l00733"></a>00733    {
<a name="l00734"></a>00734       <span class="keywordflow">if</span>($public==<span class="stringliteral">""</span>) $public=$this-&gt;public_key;
<a name="l00735"></a>00735       <span class="keywordflow">return</span> $this-&gt;tempfolder.$public.<span class="stringliteral">".jpg"</span>;
<a name="l00736"></a>00736    }
<a name="l00737"></a>00737 
<a name="l00739"></a>00739    function get_filename_url($public=<span class="stringliteral">""</span>)
<a name="l00740"></a>00740    {
<a name="l00741"></a>00741       <span class="keywordflow">if</span>($public==<span class="stringliteral">""</span>) $public = $this-&gt;public_key;
<a name="l00742"></a>00742       <span class="keywordflow">return</span> str_replace($_SERVER['DOCUMENT_ROOT'],'',$this-&gt;tempfolder).$public.<span class="stringliteral">".jpg"</span>;
<a name="l00743"></a>00743    }
<a name="l00744"></a>00744 
<a name="l00746"></a>00746    function get_try($in=TRUE)
<a name="l00747"></a>00747    {
<a name="l00748"></a>00748       $s = array();
<a name="l00749"></a>00749       <span class="keywordflow">for</span>($i = 1; $i &lt;= $this-&gt;maxtry; $i++) $s[$i] = $i;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751       <span class="keywordflow">if</span>($in)
<a name="l00752"></a>00752       {
<a name="l00753"></a>00753          <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)substr(strip_tags($_POST['hncaptcha']),($this-&gt;secretposition -1),1);
<a name="l00754"></a>00754       }
<a name="l00755"></a>00755       <span class="keywordflow">else</span>
<a name="l00756"></a>00756       {
<a name="l00757"></a>00757          $a = <span class="stringliteral">""</span>;
<a name="l00758"></a>00758          <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a> = <span class="stringliteral">""</span>;
<a name="l00759"></a>00759          <span class="keywordflow">for</span>($i = 1; $i &lt; $this-&gt;secretposition; $i++)
<a name="l00760"></a>00760          {
<a name="l00761"></a>00761             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00762"></a>00762             $a .= $s[intval(rand(1,$this-&gt;maxtry))];
<a name="l00763"></a>00763          }
<a name="l00764"></a>00764          <span class="keywordflow">for</span>($i = 0; $i &lt; (32 - $this-&gt;secretposition); $i++)
<a name="l00765"></a>00765          {
<a name="l00766"></a>00766             srand((<span class="keywordtype">double</span>)microtime()*1000000);
<a name="l00767"></a>00767             <a class="code" href="classhn__captcha.html#58d82471d71af2af8e135d4a0a8011eb">$b</a> .= $s[intval(rand(1,$this-&gt;maxtry))];
<a name="l00768"></a>00768          }
<a name="l00769"></a>00769          <span class="keywordflow">return</span> $a.$this-&gt;current_try.$b;
<a name="l00770"></a>00770       }
<a name="l00771"></a>00771    }
<a name="l00772"></a>00772 
<a name="l00774"></a>00774    function get_gd_version()
<a name="l00775"></a>00775    {
<a name="l00776"></a>00776       <span class="keyword">static</span> $gd_version_number = null;
<a name="l00777"></a>00777       <span class="keywordflow">if</span>($gd_version_number === null)
<a name="l00778"></a>00778       {
<a name="l00779"></a>00779          <span class="comment">//cr:fixed get version</span>
<a name="l00780"></a>00780          <span class="comment">//</span>
<a name="l00781"></a>00781          <span class="comment">//ob_start();</span>
<a name="l00782"></a>00782          <span class="comment">//phpinfo(8);</span>
<a name="l00783"></a>00783          <span class="comment">//$module_info = ob_get_contents();</span>
<a name="l00784"></a>00784          <span class="comment">//ob_end_clean();</span>
<a name="l00785"></a>00785          <span class="keywordflow">if</span> (function_exists('gd_info')){
<a name="l00786"></a>00786             $gdInfoArr = gd_info();
<a name="l00787"></a>00787             <span class="comment">//print_r($gdInfoArr);</span>
<a name="l00788"></a>00788             
<a name="l00789"></a>00789             
<a name="l00790"></a>00790             $module_info = (int)$gdInfoArr['GD Version'];
<a name="l00791"></a>00791             
<a name="l00792"></a>00792             <span class="keywordflow">if</span> ($module_info == ''){
<a name="l00793"></a>00793 <span class="preprocessor">               #workaround to set bundled vesion of GD linb</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span>               <span class="keywordflow">if</span> ($gdInfoArr['GD Version'] != ''){
<a name="l00795"></a>00795                   $module_info = 1;
<a name="l00796"></a>00796                }
<a name="l00797"></a>00797             }
<a name="l00798"></a>00798             
<a name="l00799"></a>00799             <span class="comment">//echo $module_info;</span>
<a name="l00800"></a>00800          }         
<a name="l00801"></a>00801          <span class="comment">//if(preg_match("/\bgd\s+version\b[^\d\n\r]+?([\d\.]+)/i", $module_info, $matches))</span>
<a name="l00802"></a>00802          <span class="keywordflow">if</span>(isset($module_info)){
<a name="l00803"></a>00803             
<a name="l00804"></a>00804             <span class="comment">//$gd_version_number = $matches[1];</span>
<a name="l00805"></a>00805             $gd_version_number = $module_info;
<a name="l00806"></a>00806          }
<a name="l00807"></a>00807          <span class="keywordflow">else</span>
<a name="l00808"></a>00808          {
<a name="l00809"></a>00809             $gd_version_number = 0;
<a name="l00810"></a>00810          }
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812       <span class="keywordflow">return</span> $gd_version_number;
<a name="l00813"></a>00813    }
<a name="l00814"></a>00814 
<a name="l00816"></a>00816    function generate_private($public=<span class="stringliteral">""</span>)
<a name="l00817"></a>00817    {
<a name="l00818"></a>00818       <span class="keywordflow">if</span>($public==<span class="stringliteral">""</span>) $public = $this-&gt;public_key;
<a name="l00819"></a>00819       <a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">$key</a> = substr(md5($this-&gt;key.$public), 16 - $this-&gt;chars / 2, $this-&gt;chars);
<a name="l00820"></a>00820       <span class="keywordflow">return</span> <a class="code" href="classhn__captcha.html#2c28d2cba19fc513f7116c3e20c45c59">$key</a>;
<a name="l00821"></a>00821    }
<a name="l00822"></a>00822 
<a name="l00831"></a>00831    function notvalid_msg()
<a name="l00832"></a>00832    {
<a name="l00833"></a>00833       <span class="comment">// blank line for all languages</span>
<a name="l00834"></a>00834       <span class="keywordflow">if</span>($this-&gt;current_try == 1) <span class="keywordflow">return</span> '&amp;nbsp;&lt;br&gt;&amp;nbsp;';
<a name="l00835"></a>00835 
<a name="l00836"></a>00836       <span class="comment">// invalid try's: en</span>
<a name="l00837"></a>00837       <span class="keywordflow">if</span>($this-&gt;lang == <span class="stringliteral">"en"</span> &amp;&amp; $this-&gt;current_try &gt; 2 &amp;&amp; $this-&gt;refreshlink) <span class="keywordflow">return</span> 'No valid entry. Please <span class="keywordflow">try</span> again:&lt;br&gt;Tipp: If you cannot identify the chars, you can generate a <span class="keyword">new</span> image!';
<a name="l00838"></a>00838       <span class="keywordflow">if</span>($this-&gt;lang == <span class="stringliteral">"en"</span> &amp;&amp; $this-&gt;current_try &gt;= 2) <span class="keywordflow">return</span> 'No valid entry. Please <span class="keywordflow">try</span> again:&lt;br&gt;&amp;nbsp;';
<a name="l00839"></a>00839 
<a name="l00840"></a>00840       <span class="comment">// invalid try's: de</span>
<a name="l00841"></a>00841       <span class="keywordflow">if</span>($this-&gt;lang == <span class="stringliteral">"de"</span> &amp;&amp; $this-&gt;current_try &gt; 2 &amp;&amp; $this-&gt;refreshlink) <span class="keywordflow">return</span> 'Die Eingabe war nicht korrekt.&lt;br&gt;Tipp: Wenn Du die Zeichen nicht erkennen kannst, generiere neue mit dem Link unten!';
<a name="l00842"></a>00842       <span class="keywordflow">if</span>($this-&gt;lang == <span class="stringliteral">"de"</span> &amp;&amp; $this-&gt;current_try &gt;= 2) <span class="keywordflow">return</span> 'Die Eingabe war nicht korrekt. Bitte noch einmal versuchen:&lt;br&gt;&amp;nbsp;';
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 } <span class="comment">// END CLASS hn_CAPTCHA</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 ?&gt;
</pre></div><hr size="1"><address style="text-align: right;"><small>Erzeugt am Fri Dec 7 10:25:12 2007 für mkSurvey von&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.4 </small></address>
</body>
</html>
